<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>mohammed tasks</title>
<meta name="theme-color" content="#c0c0c0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://unpkg.com/clippyjs@0.0.3/dist/clippy.css" media="all">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://unpkg.com/clippyjs@0.0.3/dist/clippy.min.js"></script>


<style>
  /* Styles remain the same as the previous version... */
  :root{--bg:#c0c0c0;--fg:#000000;--accent:#000080;--accent-fg:#ffffff;--line-dark:#808080;--line-medium:#a0a0a0;--line-light:#ffffff;--input-fill:#ffffff;--font:'Tahoma', 'Arial', sans-serif;--progress-color:#008040;--subtle: #d0d0d0;--taskbar-green: #008080;}
  *{box-sizing:border-box;font-family: var(--font);font-size: 10pt;transition: none !important;}
  html,body{margin:0; background:var(--taskbar-green);}
  .wrap{max-width:400px;margin: 40px auto;padding:0;background: var(--bg);box-shadow: 6px 6px 0 var(--line-dark);position: relative;}
  .window {border-style: solid;border-width: 1px;border-color: var(--fg) var(--line-light) var(--line-light) var(--fg);padding: 2px;background: var(--bg);}
  .window-inner {border-style: solid;border-width: 1px;border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark);padding: 1px;background: var(--bg);}
  .title-bar {background: var(--accent);color: var(--accent-fg);padding: 3px 6px;font-size: 11pt;font-weight: bold;display: flex;justify-content: space-between;align-items: center;border-bottom: 1px solid var(--fg);background: linear-gradient(90deg, var(--accent) 0%, #1084d8 100%);}
  .title-bar-text { flex: 1; padding-left: 8px; display: flex; align-items: center; gap: 6px; }
  .title-bar-controls button {background: var(--bg);border: 1px solid var(--fg);border-right-color: var(--line-dark);border-bottom-color: var(--line-dark);border-top-color: var(--line-light);border-left-color: var(--line-light);width: 18px; height: 18px; font-size: 10pt; padding: 0; line-height: 1;cursor: default; font-weight: bold;}
  .title-bar-controls button:active {border-left-color: var(--line-dark);border-top-color: var(--line-dark);border-right-color: var(--line-light);border-bottom-color: var(--line-light);padding: 1px 0 0 1px;}
  .main-content { padding: 8px; }
  fieldset {border-style: solid; border-width: 1px;border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark);padding: 10px; margin: 8px 0; background: var(--bg);box-shadow: 1px 1px 0 var(--line-light) inset, -1px -1px 0 var(--line-dark) inset;}
  legend {background: var(--bg); padding: 0 6px; font-weight: bold; color: var(--accent); margin-left: 5px;}
  .controls{display:flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 8px;}
  input[type="text"] {border: 1px solid var(--fg); border-left-color: var(--line-dark); border-top-color: var(--line-dark);border-right-color: var(--line-light); border-bottom-color: var(--line-light);background: var(--input-fill); color: var(--fg); padding: 4px 6px; font-size: 10pt;outline: none; box-shadow: none; flex: 1; min-width: 120px;}
  input:focus, .btn:focus, .del:focus, input[type="checkbox"]:focus, textarea:focus, input[type="date"]:focus {outline: 1px dashed var(--fg);outline-offset: -2px;}
  .btn {border: 1px solid var(--fg); border-right-color: var(--line-dark); border-bottom-color: var(--line-dark);border-top-color: var(--line-light); border-left-color: var(--line-light);background: var(--bg); color: var(--fg); padding: 5px 12px; font-weight: normal;cursor: pointer; box-shadow: none; line-height: 1; font-size: 10pt; flex-shrink: 0;}
  .btn:active {border: 1px solid var(--fg); border-left-color: var(--line-dark); border-top-color: var(--line-dark);border-right-color: var(--line-light); border-bottom-color: var(--line-light);padding: 6px 12px 4px 12px;}
  .btn.ghost { background: var(--bg); box-shadow: none; }
  .btn:hover { background: var(--subtle); }
  .btn:disabled { color: var(--line-dark); text-shadow: 1px 1px var(--line-light); cursor: not-allowed;} /* Style disabled buttons */
  .muted{color:var(--fg);font-size:9pt; padding: 0 4px;}
  .toolbar {display: flex; gap: 4px;padding: 0;margin-top: 8px;}
  .toolbar button {border: 1px solid var(--fg); border-right-color: var(--line-dark); border-bottom-color: var(--line-dark);border-top-color: var(--line-light); border-left-color: var(--line-light);padding: 4px 8px;flex: 1;}
  .toolbar button:active { padding: 5px 8px 3px 8px; }
  .task-list-box {border: 1px solid var(--fg); border-left-color: var(--line-dark); border-top-color: var(--line-dark);border-right-color: var(--line-light); border-bottom-color: var(--line-light);background: var(--input-fill); padding: 0; min-height: 100px; margin-top: 8px;box-shadow: 1px 1px 0 var(--line-dark) inset, -1px -1px 0 var(--line-light) inset;}
  ul{list-style:none;padding:0;margin:0}
  li{display:flex; align-items:center; gap:8px; padding: 4px 8px;background: var(--input-fill); color: var(--fg); margin: 0;border-bottom: 1px solid var(--line-medium);cursor: default;}
  li:hover { background: var(--subtle); }
  li.done { color: var(--line-dark); opacity: 0.9; }
  li.done .txt { text-decoration: line-through; }
  .txt{flex:1; line-height:1.4; font-size: 10pt; min-width: 0;}
  input[type="checkbox"]{appearance: none; width: 13px; height: 13px;border: 1px solid var(--fg); background: var(--input-fill);box-shadow: 1px 1px 0 var(--line-dark) inset, -1px -1px 0 var(--line-light) inset;margin: 0; padding: 0; display: grid; place-items: center; flex-shrink: 0;cursor: pointer;}
  input[type="checkbox"]:checked::after { content: 'âœ“'; color: var(--fg); font-size: 10pt; line-height: 0.8; }
  input[type="checkbox"]:active { box-shadow: 1px 1px 0 var(--line-light) inset, -1px -1px 0 var(--line-dark) inset; }
  input[type="checkbox"]:disabled { background: var(--subtle); box-shadow: none; cursor: not-allowed; } /* Style disabled checkbox */
  input[type="checkbox"]:disabled::after { color: var(--line-dark); }
  .del{appearance:none; border:0; background:transparent; color:var(--line-dark); font-size:10pt;cursor: pointer; padding: 0 4px; line-height:1; flex-shrink: 0;}
  .del:hover{color:red;}
  .del:disabled { color: var(--line-medium); cursor: not-allowed; } /* Style disabled delete */
  .linear-progress-box { margin-top: 8px; }
  .head{display:flex;justify-content:space-between;align-items:center;margin:0 0 4px 0}
  .big{font-weight:bold; font-size: 11pt;}
  .progress{height:14px; background: var(--line-dark);border: 1px solid var(--fg); border-left-color: var(--line-dark); border-top-color: var(--line-dark);border-right-color: var(--line-light); border-bottom-color: var(--line-light);overflow:hidden; padding: 2px;}
  .bar{ height:100%; width:0; background: var(--progress-color); }
  .status-bar {border-top: 1px solid var(--line-light);display: flex; align-items: center;padding: 0 0;background: var(--bg);height: 24px;position: absolute;bottom: -2px;left: 2px;right: 2px;width: calc(100% - 4px);}
  .start-btn {background: var(--bg);border: 1px solid var(--fg); border-right-color: var(--line-dark); border-bottom-color: var(--line-dark);border-top-color: var(--line-light); border-left-color: var(--line-light);font-weight: bold;padding: 1px 6px 0 6px;margin-right: 2px;height: 100%;line-height: 1.8;font-size: 11pt;color: var(--fg);cursor: pointer;box-shadow: none;flex-shrink: 0;}
  .start-btn:active {border: 1px solid var(--fg); border-left-color: var(--line-dark); border-top-color: var(--line-dark);border-right-color: var(--line-light); border-bottom-color: var(--line-light);padding: 2px 6px 0 7px;}
  .separator {height: 100%;width: 2px;background: var(--bg);border-left: 1px solid var(--line-light);border-right: 1px solid var(--line-dark);margin: 0 2px;}
  .status-panel-group {display: flex;margin-left: auto;align-items: center;height: 100%;}
  .status-panel {border: 1px solid var(--line-dark); border-left-color: var(--line-light); border-top-color: var(--line-light);padding: 0 8px; line-height: 2.1; font-size: 9pt; flex-shrink: 0; min-width: 60px;height: calc(100% - 4px);margin: 2px 0 2px 2px;}
  .main-content { padding: 8px 8px 30px 8px; }
  .counters-container {display: grid;grid-template-columns: 1fr 1fr 1fr;gap: 8px;padding: 0 0 8px 0;}
  .counter-fieldset {text-align: center;padding: 8px 5px 5px 5px;}
  .counter-fieldset legend {font-weight: bold;padding: 0 4px;font-size: 9pt;}
  .counter-fieldset h1 {font-size: 2.2rem;margin: 0 0 5px 0;font-weight: bold;color: #000;line-height: 1;}
  .counter-fieldset button {font-size: 1.1rem;font-weight: bold;width: 100%;height: 28px;padding: 0;}
  .counter-fieldset button:disabled {color: var(--line-dark);text-shadow: 1px 1px var(--line-light);cursor: not-allowed;}
  .emergency-fieldset {background-color: #CC4444;color: #FFFFFF;}
  .emergency-fieldset h1 {color: #FFFFFF;}
  .emergency-fieldset legend {color: #FFFFFF;background: #CC4444;}
  hr {border: 0;border-top: 1px solid var(--line-dark);border-bottom: 1px solid var(--line-light);margin: 15px 0;}
  .info-box fieldset {margin-top: 0;padding: 8px;}
  .info-box legend {font-size: 9pt;margin-left: 2px;}
  #emergency-log {width: 100%;box-sizing: border-box;font-family: var(--font);font-size: 9pt;background: var(--input-fill);color: var(--fg);border: 1px solid var(--fg);border-left-color: var(--line-dark);border-top-color: var(--line-dark);border-right-color: var(--line-light);border-bottom-color: var(--line-light);box-shadow: 1px 1px 0 var(--line-dark) inset, -1px -1px 0 var(--line-light) inset;}
  .status-panel-btn {cursor: pointer;border: 1px solid var(--line-light);border-right-color: var(--line-dark);border-bottom-color: var(--line-dark);}
  .status-panel-btn:active {border: 1px solid var(--line-dark);border-right-color: var(--line-light);border-bottom-color: var(--line-light);}
  #clippy-panel-btn {font-size: 1.2rem;line-height: 1.5;padding: 0 6px;min-width: 30px;}
  #report-panel-btn {padding: 0 6px;}
  #reset-today-panel-btn {padding: 0 6px;}
  #logon-screen {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: var(--taskbar-green);display: flex;justify-content: center;align-items: center;z-index: 1000;}
  #logon-window {width: 350px;padding-bottom: 10px;}
  #logon-content {padding: 20px;display: flex;align-items: center;gap: 15px;}
  #logon-content i {font-size: 48px;color: var(--accent);}
  #logon-buttons {text-align: center;padding: 0 20px;}
  #logon-ok {width: 100px;}
  .dread-btn {appearance: none; border: 0; background: transparent;font-size: 1.1rem; cursor: pointer; padding: 0 4px; line-height: 1; flex-shrink: 0;}
  .dread-btn:hover { opacity: 0.6; }
  .dread-btn:active { transform: scale(0.9); }
  .dread-btn:disabled { cursor: not-allowed; opacity: 0.5; } /* Style disabled dread button */
  .dread-analysis-panel {padding: 5px;font-size: 0.95rem;}
  .dread-analysis-panel .task-name {font-weight: bold;color: var(--accent);}
  .history-controls {display: flex;gap: 8px;align-items: center;}
  .history-controls input[type="date"] {border: 1px solid var(--fg); border-left-color: var(--line-dark); border-top-color: var(--line-dark);border-right-color: var(--line-light); border-bottom-color: var(--line-light);background: var(--input-fill); color: var(--fg); padding: 4px 6px; font-size: 10pt;outline: none; box-shadow: none; flex: 1; height: 30px;}
  .history-controls button {flex-shrink: 0; height: 30px;}
  @media (max-width: 768px) {.wrap {max-width: 100%;margin: 0;height: 100vh;box-shadow: none;}.main-content { padding: 4px 4px 30px 4px; }.controls { flex-direction: column; align-items: stretch; gap: 4px; }.controls > * { width: 100%; }.controls label { flex: none; width: 100%; padding-bottom: 2px; }.toolbar button { flex: 1; }.task-list-box { min-height: 200px; }li { padding: 6px 8px; }.status-bar { width: 100%; left: 0; right: 0; bottom: 0; position: fixed; }.status-panel-group { margin-left: auto; }.counters-container {gap: 4px;padding: 4px 0 4px 0;}.counter-fieldset {padding: 6px 4px 4px 4px;}.counter-fieldset h1 {font-size: 1.8rem;}.counter-fieldset button {height: 24px;font-size: 1rem;}.counter-fieldset legend {font-size: 8pt;}.info-box p, .info-box .sunken-panel {font-size: 8pt;}.history-controls {flex-direction: column;align-items: stretch;}.history-controls input[type="date"] {margin-bottom: 4px;}}
</style>
</head>
<body dir="ltr">

  <div id="logon-screen">
    <div class="window" id="logon-window">
        <div class="title-bar">
            <div class="title-bar-text">Logon to Mohammed's System</div>
        </div>
        <div id="logon-content">
            <i class="fas fa-user-circle"></i>
            <div>
                <p style="margin: 0 0 5px 0;">Welcome back, <strong>Mohammed</strong>.</p>
                <p style="margin: 0;">Click OK to load your task environment.</p>
            </div>
        </div>
        <div id="logon-buttons">
            <button class="btn" id="logon-ok">OK</button>
        </div>
    </div>
  </div>

  <main class="wrap window">
    <div class="window-inner">
      <div class="title-bar">
          <div class="title-bar-text">
              <i class="fas fa-user-circle"></i>
              <span>mohammed tasks</span>
          </div>
          <div class="title-bar-controls">
              <button title="Minimize" class="title-btn-min">_</button>
              <button title="Maximize" class="title-btn-max">â–¡</button>
              <button title="Close" class="title-btn-close">X</button>
          </div>
      </div>

      <div class="main-content">

        <div class="counters-container">
            <fieldset class="counter-fieldset">
                <legend>Achievements</legend>
                <h1 id="achievements-count">0</h1>
                <button onclick="counter_increment('achievements')" class="btn">+</button>
            </fieldset>

            <fieldset class="counter-fieldset">
                <legend>Neutral</legend>
                <h1 id="neutral-count">0</h1>
                <button onclick="counter_increment('neutral')" class="btn">+</button>
            </fieldset>

            <fieldset class="counter-fieldset emergency-fieldset">
                <legend>Emergency</legend>
                <h1 id="emergency-count">0</h1>
                <button onclick="counter_increment('emergency')" class="btn">+</button>
            </fieldset>
        </div>

        <div class="info-box" style="padding: 0; margin: 0;">
            <fieldset>
                <legend id="emergency-log-legend">Today's Emergency Log</legend>
                <div style="padding: 5px;">
                    <textarea id="emergency-log" readonly rows="3"></textarea>
                </div>
            </fieldset>
        </div>

        <hr>

        <fieldset id="add-task-fieldset">
            <legend>Add New Task</legend>
            <div class="controls">
                <label for="newTask" style="flex: 0 0 100px;">Task (Required):</label>
                <input id="newTask" type="text" placeholder="Brief description of the taskâ€¦"/>
            </div>

            <div class="toolbar">
                <button class="btn" id="addBtn"><i class="fas fa-plus"></i> Add Task</button>
                <button class="btn ghost" id="resetAllBtn" title="Delete ALL tasks & Today's Counters"><i class="fas fa-trash-alt"></i> Reset All</button>
            </div>
        </fieldset>

         <div id="progress-bar-container" class="linear-progress-box">
          <div class="head">
            <div><span class="big" id="pct1">0%</span> <span class="muted">Overall Progress</span></div>
            <div class="muted"><span id="done1">0</span>/<span id="total1">0</span> Tasks</div>
          </div>
          <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div id="bar1" class="bar"></div>
          </div>
        </div>

        <fieldset>
            <legend>Historical View</legend>
            <div class="history-controls">
                <input type="date" id="history-date-input">
                <button class="btn" id="history-load-btn">Load Date</button>
                <button class="btn ghost" id="history-today-btn" style="display: none;">Back to Today</button>
            </div>
        </fieldset>

        <fieldset id="dread-analysis-fieldset" class="info-box" style="padding: 8px; margin-top: 15px;">
            <legend>Dread Analysis</legend>
            <div class="dread-analysis-panel">
                <span>Most Evaded Task:</span>
                <span id="dread-task-name" class="task-name">(None)</span>
            </div>
        </fieldset>

         <fieldset id="task-list-fieldset">
             <legend id="task-list-legend">Current Tasks</legend>
             <div class="task-list-box">
                 <ul id="list"></ul>
             </div>
             <div id="emptyMessage" class="muted" style="text-align: center; margin-top: 8px; font-weight: bold; display: none;">
                 No tasks currently. Start by adding one!
             </div>
         </fieldset>

      </div>

      <div class="status-bar">
          <button class="start-btn">Start</button>
          <div class="separator"></div>
          <div class="status-panel" style="flex-grow: 1; margin-right: 0; text-align: left; min-width: 0;">
              mohammed tasks
          </div>
          <div class="status-panel-group">
            <div class="status-panel status-panel-btn" id="clippy-panel-btn" role="button" title="Get Smart Analysis">
              ðŸ“Ž
            </div>
            <div class="status-panel status-panel-btn" id="report-panel-btn" role="button" title="Generate Daily Report">
              <i class="fas fa-print"></i> Report
            </div>
            <div class="status-panel status-panel-btn" id="reset-today-panel-btn" role="button" title="Reset Today's Counters & Log">
              <i class="fas fa-undo"></i> Reset Today
            </div>
            <div class="status-panel" id="status-total">Total: 0</div>
            <div class="status-panel" id="status-save">Ready</div>
          </div>
      </div>
    </div>
  </main>

  <audio id="sound-tada" src="https://www.myinstants.com/media/sounds/tada.mp3" preload="auto"></audio>
  <audio id="sound-error" src="https://www.myinstants.com/media/sounds/windows-xp-error.mp3" preload="auto"></audio>

<script>
// =================================================================
// ðŸ”¥ FIREBASE INITIALIZATION & CONFIG ðŸ”¥
// =================================================================
const firebaseConfig = {
  apiKey: "AIzaSyBvpcUP-DmXH82WHgm4ZLHezeBFaaxMnCE",
  authDomain: "mohammedtasksapp.firebaseapp.com",
  databaseURL: "https://mohammedtasksapp-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mohammedtasksapp",
  storageBucket: "mohammedtasksapp.firebasestorage.app",
  messagingSenderId: "271781862481",
  appId: "1:271781862481:web:dfd63b2c4b4a8d74ad2c70"
};

let db = null;
let firebaseInitialized = false; // Flag to track initialization
try {
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase initialized successfully.");
    } else {
        firebase.app();
        console.log("Firebase already initialized.");
    }
    db = firebase.database();
    firebaseInitialized = true; // Set flag on success
} catch (e) {
    console.error("Firebase initialization failed:", e);
    firebaseInitialized = false; // Ensure flag is false on error
    // Error handling moved to DOMContentLoaded
}

// =================================================================
// ðŸ”¥ GLOBAL VARIABLES & DOM ELEMENTS ðŸ”¥
// =================================================================
let todayCounterRef = null;
let currentCounters = { achievements: 0, neutral: 0, emergency: 0, emergencyLog: [] };
let isViewingHistory = false;
let tasks = [];
let clippyAgent = null;

// DOM Elements
let listEl, newTaskEl, addBtn, resetAllBtn, emptyMessageEl, statusTotalEl, statusSaveEl;
let historyDateInput, historyLoadBtn, historyTodayBtn;
let dreadTaskNameEl;
let allCounterButtons;
let reportBtnEl, clippyBtnEl, resetTodayBtnEl;
let logTextareaEl, emergencyLogLegendEl;
let soundTada, soundError;
let logonScreenEl, logonBtnEl;
let addTaskFieldset, progressBarContainer, dreadAnalysisFieldset, taskListLegendEl;


// =================================================================
// ðŸ”¥ HELPER FUNCTIONS (UTILS) ðŸ”¥
// =================================================================
function getTodayDateString() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function updateStatus(message) {
    if (statusSaveEl) {
        statusSaveEl.textContent = message;
        const isError = /error|fail|missing/i.test(message);
        if (!isError) {
             setTimeout(() => { if (statusSaveEl && statusSaveEl.textContent === message) statusSaveEl.textContent = 'Ready'; }, 2500);
        }
    }
}

function clippySpeak(message, hold = false) {
    if (clippyAgent) {
        clippyAgent.speak(message, hold);
    } else {
        console.log("Clippy fallback (agent not ready):", message);
         // Optionally use alert as fallback ONLY if Clippy fails completely
         // alert(message);
    }
}

// Check if PDF libraries are truly ready
function checkPdfLibraries() {
    const ready = typeof window.jspdf !== 'undefined' &&
                  typeof window.jspdf.jsPDF === 'function' &&
                  typeof window.jspdf.plugin !== 'undefined' &&
                  typeof window.jspdf.plugin.autotable === 'function';
    if (!ready) {
        console.error("jsPDF or jsPDF-AutoTable not fully loaded!");
        clippySpeak("PDF libraries are missing or still loading. Cannot generate report. Check internet connection and maybe wait a bit?");
        updateStatus("PDF Lib Error");
        alert("Error: PDF Generation Failed (Libraries Not Ready).\n\nPlease ensure you are connected to the internet and try refreshing the page (Ctrl+Shift+R). Wait a few seconds after the page loads before trying again.");
    }
    return ready;
}


// =================================================================
// ðŸ”¥ COUNTER LOGIC (Firebase) ðŸ”¥
// =================================================================
// ... (counter_listenForChanges, updateCounterUI, counter_increment - largely unchanged) ...
function counter_listenForChanges(dateString) {
    if (!db) { console.warn("DB not ready for counter listen."); return; }
    const dateToLoad = dateString || getTodayDateString(); // Use helper
    const newRefPath = 'dailyCounters/' + dateToLoad;
    const newRef = db.ref(newRefPath);

    if (todayCounterRef && todayCounterRef.toString() !== newRef.toString()) {
        console.log("Turning off listener for:", todayCounterRef.toString());
        todayCounterRef.off('value');
        todayCounterRef = null;
    }

    if (!todayCounterRef) {
        console.log("Attaching listener for:", newRefPath);
        todayCounterRef = newRef;
        todayCounterRef.on('value', (snapshot) => {
            const data = snapshot.val();
            console.log("Counter data received for", dateToLoad, ":", data);
            currentCounters = data ? { ...data, emergencyLog: data.emergencyLog || [] }
                                   : { achievements: 0, neutral: 0, emergency: 0, emergencyLog: [] };
            if (!data && !isViewingHistory && dateToLoad === getTodayDateString()) {
                console.log("Setting default counters for today.");
                todayCounterRef.set(currentCounters).catch(e => console.error("Initial counter set failed:", e));
            }
            updateCounterUI();
        }, (error) => {
            console.error(`Firebase Counter Read Failed for ${dateToLoad}. Check Rules:`, error);
            updateStatus('Counter Sync Error');
            currentCounters = { achievements: 0, neutral: 0, emergency: 0, emergencyLog: [] };
            updateCounterUI();
        });
    } else {
         console.log("Already listening to counters:", newRefPath);
         updateCounterUI();
    }
}

function updateCounterUI() {
    const achEl = document.getElementById('achievements-count');
    const neuEl = document.getElementById('neutral-count');
    const emgEl = document.getElementById('emergency-count');
    if (achEl) achEl.innerText = currentCounters.achievements || 0;
    if (neuEl) neuEl.innerText = currentCounters.neutral || 0;
    if (emgEl) emgEl.innerText = currentCounters.emergency || 0;

    const logData = currentCounters.emergencyLog || [];
    if (logTextareaEl) {
        logTextareaEl.value = logData.length > 0 ? logData.join('\n')
                           : (isViewingHistory ? '(No data for this day)' : '(No emergencies logged today)');
        logTextareaEl.scrollTop = logTextareaEl.scrollHeight;
    }

    if (allCounterButtons) allCounterButtons.forEach(btn => btn.disabled = isViewingHistory);
    if (historyTodayBtn) historyTodayBtn.style.display = isViewingHistory ? 'inline-block' : 'none';
    if (historyLoadBtn) historyLoadBtn.style.display = isViewingHistory ? 'none' : 'inline-block';

    if (emergencyLogLegendEl) {
        emergencyLogLegendEl.textContent = isViewingHistory && historyDateInput ? `Emergency Log (${historyDateInput.value})` : "Today's Emergency Log";
    }

    const showTodayElements = !isViewingHistory;
    if (addTaskFieldset) addTaskFieldset.style.display = showTodayElements ? '' : 'none';
    if (progressBarContainer) progressBarContainer.style.display = showTodayElements ? '' : 'none';
    if (dreadAnalysisFieldset) dreadAnalysisFieldset.style.display = showTodayElements ? '' : 'none';
    if (taskListLegendEl) taskListLegendEl.textContent = showTodayElements ? "Current Tasks" : (historyDateInput ? `Tasks Created On (${historyDateInput.value})` : "Tasks");
}

function counter_increment(type) {
    if (!db || !todayCounterRef) { console.warn("Cannot increment: DB/Ref missing."); clippySpeak("DB connection error."); return; }
    if (isViewingHistory) { clippySpeak("Cannot add data in 'History View'."); return; }

    let finalReason = "";
    let updates = {};

    if (type === 'emergency') {
        let reasonInput = prompt("EMERGENCY:\n\n1. Social Media\n2. Phone/Calls\n3. Procrastination\n4. Other (Specify)", "");
        if (reasonInput === null) return;
        finalReason = reasonInput === "1" ? "Social Media"
                    : reasonInput === "2" ? "Phone/Calls"
                    : reasonInput === "3" ? "Procrastination"
                    : reasonInput === "4" ? (prompt("Specify 'Other' reason:", "") || "Other (Unspecified)")
                    : reasonInput.trim() || "Other (Unspecified)";

        const currentLog = Array.isArray(currentCounters.emergencyLog) ? [...currentCounters.emergencyLog] : [];
        currentLog.push(finalReason);
        updates.emergencyLog = currentLog;
        if (soundError) soundError.play().catch(e => console.warn("Audio play failed:", e));
    }

    todayCounterRef.child(type).transaction((currentCount) => (currentCount || 0) + 1,
        (error, committed, snapshot) => {
            if (error) { console.error('Counter transaction failed!', error); updateStatus('Counter Save Error'); }
            else if (committed) {
                console.log('Counter transaction committed.');
                if (type === 'achievements' && snapshot.val() === 10) { clippySpeak("Congratulations! 10 Achievements!"); }
            } else { console.warn('Counter transaction not committed.'); }
        }
    );

    if (updates.emergencyLog) {
         todayCounterRef.update({ emergencyLog: updates.emergencyLog }).catch(e => { console.error("Log update failed:", e); updateStatus('Log Save Error'); });
    }
}


// =================================================================
// ðŸ”¥ TASK APP LOGIC (Firebase) ðŸ”¥
// =================================================================

const tasksRef = db ? db.ref('tasks') : null;

// ... (listenForTasks, addTaskToDB, updateTaskStatus, incrementDreadCount, deleteTask, deleteAllTasks - largely unchanged but added DB check) ...
function listenForTasks() {
    if (!tasksRef) { console.warn("DB not ready for task listen."); return; }
    tasksRef.on('value', (snapshot) => {
        const rawData = snapshot.val();
        tasks = [];
        if (rawData) {
            for (let id in rawData) {
                tasks.push({ ...rawData[id], id: id, dreadCount: rawData[id].dreadCount || 0 });
            }
        }
        // Conditional rendering based on history view
        if (!isViewingHistory) {
             renderList(); // Render all tasks
        } else if (historyDateInput && historyDateInput.value) {
            // If in history view, re-filter and render just in case task data changed
             const filteredTasks = tasks.filter(task => task.createdDate === historyDateInput.value);
             renderList(filteredTasks);
        }
        // Always update progress/analysis based on full task list
        updateLinearView();
        updateDreadAnalysis();
        updateStatus('Synced');
    }, (error) => {
        console.error("Firebase Task Read Failed. Check Rules:", error);
        updateStatus('Task Sync Error');
    });
}

function addTaskToDB(text) {
    if (!tasksRef) { updateStatus("DB Error"); return; }
    const newTask = { text: text, done: false, createdDate: getTodayDateString(), dreadCount: 0 }; // Use helper
    tasksRef.push(newTask).catch((error) => { console.error("Firebase Write Failed:", error); updateStatus('Write Error'); });
}

function updateTaskStatus(id, isDone) {
    if (!tasksRef) { updateStatus("DB Error"); return; }
    tasksRef.child(id).update({ done: isDone }).catch((error) => { console.error("Firebase Update Failed:", error); updateStatus('Update Error'); });
    if (isDone && soundTada) soundTada.play().catch(e => console.warn("Audio play failed:", e));
}

function incrementDreadCount(id) {
    if (!tasksRef) { updateStatus("DB Error"); return; }
    tasksRef.child(id).child('dreadCount').transaction((currentCount) => (currentCount || 0) + 1);
}

function deleteTask(id) {
    if (!tasksRef) { updateStatus("DB Error"); return; }
    tasksRef.child(id).remove().catch((error) => { console.error("Firebase Delete Failed:", error); updateStatus('Delete Error'); });
}

function deleteAllTasks() {
    if (!tasksRef) { updateStatus("DB Error"); return; }
    tasksRef.remove().catch((error) => { console.error("Firebase Clear Failed:", error); updateStatus('Clear Error'); });
}

// ... (getSortedTasks, renderList, updateDreadAnalysis, handleAddTask, handleResetAll, handleResetTodayCounters, getProgress, updateLinearView - largely unchanged, check renderList for history disabling logic) ...
function getSortedTasks(tasksArray = tasks) { // Accept array to sort
    return [...tasksArray].sort((a, b) => (b.createdDate || "").localeCompare(a.createdDate || ""));
}

function renderList(tasksToRender) {
    const displayTasks = tasksToRender || tasks; // Use filtered list if provided, else global
    const sortedTasks = getSortedTasks(displayTasks); // Sort the correct list

    if (!listEl) return;
    listEl.innerHTML = '';

    const isInHistory = isViewingHistory; // Cache history status

    if (sortedTasks.length === 0) {
        if (emptyMessageEl) {
             emptyMessageEl.textContent = isInHistory ? "No tasks created on this date." : "No tasks currently. Start by adding one!";
             emptyMessageEl.style.display = 'block';
        }
    } else {
        if (emptyMessageEl) emptyMessageEl.style.display = 'none';
    }

    sortedTasks.forEach(t => {
        const li = document.createElement('li');
        if (t.done) li.classList.add('done');

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = t.done;
        cb.disabled = isInHistory; // Disable controls in history
        if (!isInHistory) {
            cb.addEventListener('change', () => { updateTaskStatus(t.id, cb.checked); });
        }

        const span = document.createElement('span');
        span.className = 'txt';
        span.textContent = t.text;

        const dreadBtn = document.createElement('button');
        dreadBtn.className = 'dread-btn';
        dreadBtn.title = `Mark as dreaded (${t.dreadCount || 0})`;
        dreadBtn.innerHTML = 'ðŸ˜°';
        dreadBtn.disabled = isInHistory;
        if (!isInHistory) {
             dreadBtn.addEventListener('click', () => { incrementDreadCount(t.id); });
        }

        const del = document.createElement('button');
        del.className = 'del';
        del.innerHTML = '<i class="fas fa-trash"></i>';
        del.disabled = isInHistory;
        if (!isInHistory) {
             del.addEventListener('click', () => { deleteTask(t.id); });
        }

        li.appendChild(cb);
        li.appendChild(span);
        li.appendChild(dreadBtn);
        li.appendChild(del);
        listEl.appendChild(li);
    });

    // Always update total based on *all* tasks
    if (statusTotalEl) statusTotalEl.textContent = `Total: ${tasks.length}`;
}

function updateDreadAnalysis() {
    if (!dreadTaskNameEl) return;
    const pendingTasks = tasks.filter(t => !t.done);
    if (pendingTasks.length === 0) { dreadTaskNameEl.textContent = '(None)'; return; }
    const mostDreaded = pendingTasks.sort((a, b) => {
        const dreadDiff = (b.dreadCount || 0) - (a.dreadCount || 0);
        return dreadDiff !== 0 ? dreadDiff : (b.createdDate || "").localeCompare(a.createdDate || "");
    })[0];
    dreadTaskNameEl.textContent = (mostDreaded && mostDreaded.dreadCount > 0) ? `${mostDreaded.text} (${mostDreaded.dreadCount})` : '(None)';
}

function handleAddTask(){
     if (isViewingHistory) return;
    const text = (newTaskEl.value||'').trim();
    if(!text) { clippySpeak("Please enter a task description!"); return; }
    addTaskToDB(text);
    newTaskEl.value='';
    newTaskEl.focus();
}

function handleResetAll(){
    if(!confirm('ARE YOU SURE?\n\nDelete ALL tasks permanently?\nReset today\'s counters and log?')) return;
    deleteAllTasks();
    if (todayCounterRef && !isViewingHistory) {
         const defaultCounters = { achievements: 0, neutral: 0, emergency: 0, emergencyLog: [] };
         todayCounterRef.set(defaultCounters).then(() => { clippySpeak("All tasks & today's counters reset."); updateStatus("All Reset"); })
                      .catch(e => console.error("Counter reset failed:", e));
    } else if (isViewingHistory) { clippySpeak("Tasks cleared. Historical counters remain."); }
}

function handleResetTodayCounters() {
    if (isViewingHistory) { clippySpeak("Cannot reset historical data."); return; }
    if (!confirm('Reset Today\'s Counters & Log?\n(Tasks NOT affected)')) return;
    if (todayCounterRef) {
         const defaultCounters = { achievements: 0, neutral: 0, emergency: 0, emergencyLog: [] };
         todayCounterRef.set(defaultCounters).then(() => { clippySpeak("Today's counters reset."); updateStatus("Counters Reset"); })
                      .catch(e => { console.error("Counter reset failed:", e); updateStatus('Reset Error'); });
    }
}

function getProgress(){
    const total = tasks.length; const done = tasks.filter(t=>t.done).length;
    const pct = total ? Math.round((done/total)*100) : 0;
    return {total, done, pct};
}

function updateLinearView(){
    const {total,done,pct} = getProgress();
    const bar = document.getElementById('bar1'); const pctEl = document.getElementById('pct1');
    const doneEl= document.getElementById('done1'); const totalEl= document.getElementById('total1');
    if(bar) bar.style.width = pct + '%'; if(pctEl) pctEl.textContent = pct + '%';
    if(doneEl) doneEl.textContent = done; if(totalEl) totalEl.textContent = total;
    const pb = document.querySelector('#v-linear .progress[role="progressbar"]');
    if(pb) pb.setAttribute('aria-valuenow', pct);
}


// =================================================================
// ðŸ”¥ Report & Clippy Logic ðŸ”¥
// =================================================================
// ... (analyzeDay remains the same)
function analyzeDay() {
    const counters = currentCounters; const allTasks = tasks;
    const ach = counters.achievements || 0; const emg = counters.emergency || 0;
    const log = counters.emergencyLog || []; let taskAnalysis = "";
    let level = ""; let advice = "";
    const { total, done, pct } = getProgress();
    if (!isViewingHistory) { taskAnalysis = `You also completed ${done}/${total} tasks today (${pct}%).`; }
    if (ach >= 10 && emg < 3) { level = "Excellent Focus"; advice = `Incredible performance! ${taskAnalysis} Keep this momentum!`; }
    else if (ach >= 5 && emg < ach) { level = "Productive Day"; advice = `Solid work, balanced well. ${taskAnalysis} Great job!`; }
    else if (ach > 0 && emg >= ach) { level = "Distracted Day"; advice = `Distractions led today. Review the log. ${taskAnalysis} New start tomorrow.`; }
    else if (ach === 0 && emg > 0) { level = "High Evasion Day"; advice = `Tough start. One achievement can break the cycle. ${taskAnalysis}`; }
    else { level = "Quiet/Rest Day"; advice = `A quiet day. Planned rest? ${taskAnalysis}`; }
    const quotes = ["Get started.", "Discipline bridges goals & accomplishment.", "Focus on progress."];
    const quote = quotes[Math.floor(Math.random() * quotes.length)];
    return { level, advice, quote, ach, emg, totalTasks: total, doneTasks: done, pctTasks: pct, log, allTasks };
}

// ... (showClippyAnalysis remains the same)
function showClippyAnalysis() {
    if (typeof clippy === 'undefined') { alert("Clippy library failed to load."); return; }
    if (!clippyAgent) { alert("Clippy is still loading..."); return; }
    const analysis = analyzeDay();
    clippyAgent.stop(); clippyAgent.show();
    clippySpeak(`Hi Mohammed! Analysis for ${isViewingHistory && historyDateInput ? `date ${historyDateInput.value}` : 'today'}:`);
    clippySpeak(`Level: ${analysis.level}.`);
    clippySpeak(analysis.advice);
    clippySpeak(`Quote: ${analysis.quote}`);
    clippyAgent.animate();
}

// UPDATED generateDailyReport with refined library check
function generateDailyReport() {
    // Check libraries *immediately* before trying to use them
    if (!checkPdfLibraries()) {
        return; // Exit if check fails (error message shown in check function)
    }

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const dateStr = isViewingHistory && historyDateInput ? historyDateInput.value : getTodayDateString();
        const analysis = analyzeDay();

        doc.setFont('Helvetica', 'normal'); // Default font

        doc.setFont('Helvetica', 'bold'); doc.setFontSize(18); doc.text("Mohammed's Daily Report", 14, 22);
        doc.setFontSize(12); doc.setFont('Helvetica', 'normal'); doc.text(`Date: ${dateStr}`, 14, 30);
        doc.line(14, 35, 196, 35);
        doc.setFont('Helvetica', 'bold'); doc.setFontSize(14); doc.text("Analysis:", 14, 45);
        doc.setFont('Helvetica', 'normal'); doc.setFontSize(12); doc.text(`Level: ${analysis.level}`, 14, 53);
        doc.setFont('Helvetica', 'italic');
        const adviceLines = doc.splitTextToSize(analysis.advice, 182);
        doc.text(adviceLines, 14, 61);
        let y = 61 + (adviceLines.length * 7) + 5;

        if (y > 270) { doc.addPage(); y = 20; }
        doc.setFont('Helvetica', 'bold'); doc.setFontSize(14); doc.text("Summary:", 14, y); y += 8;
        doc.setFont('Helvetica', 'normal'); doc.setFontSize(12);
        doc.text(`- Achievements: ${analysis.ach}`, 20, y); doc.text(`- Emergencies: ${analysis.emg}`, 100, y); y += 8;
        doc.text(`- Tasks Completed: ${analysis.doneTasks} / ${analysis.totalTasks} (${analysis.pctTasks}%)`, 20, y); y += 10;

        if (y > 270) { doc.addPage(); y = 20; }
        doc.setFont('Helvetica', 'bold'); doc.setFontSize(14); doc.text("Emergency Log:", 14, y); y += 8;
        doc.setFont('Helvetica', 'normal'); doc.setFontSize(10);
        if (analysis.log && analysis.log.length > 0) {
            const logLines = analysis.log.map((entry, index) => `${index + 1}. ${entry}`);
             const splitLog = doc.splitTextToSize(logLines.join('\n'), 182);
             if (y + (splitLog.length * 5) > 280) { doc.addPage(); y = 20;}
             doc.text(splitLog, 14, y, { lang: 'ar' }); // Attempt basic Arabic rendering
             y += (splitLog.length * 5) + 5;
        } else {
            if (y > 270) { doc.addPage(); y = 20; }
            doc.text("(No emergencies logged.)", 14, y); y += 10;
        }

        if (analysis.allTasks.length > 0) {
            const completedTasks = analysis.allTasks.filter(t => t.done).map(t => [t.text]);
            const pendingTasks = analysis.allTasks.filter(t => !t.done).map(t => [t.text]);
            const tableOptions = { startY: y, theme: 'grid', headStyles: { font: 'Helvetica', fontStyle: 'bold', fillColor: [220, 220, 220], textColor: [0, 0, 0], fontSize: 10 }, bodyStyles: { font: 'Helvetica', fontStyle: 'normal', fontSize: 9, cellPadding: 2 }, columnStyles: { 0: { cellWidth: 'auto' } }, margin: { left: 14, right: 14 }, didDrawPage: function(data) { y = data.cursor.y + 10; } };
            const drawTable = (headText, bodyData) => {
                 const estimatedHeight = (bodyData.length + 1) * 7 + 10;
                 if (y + estimatedHeight > 280) { doc.addPage(); y = 20; }
                 tableOptions.startY = y;
                 doc.autoTable({ ...tableOptions, head: [[headText]], body: bodyData });
                 y = doc.autoTable.previous.finalY + 10;
             };
            if (completedTasks.length > 0) { drawTable('Completed Tasks', completedTasks); }
            if (pendingTasks.length > 0) { drawTable('Pending Tasks', pendingTasks); }
        }

        if (y > 270) { doc.addPage(); y = 20; }
        doc.setFont('Helvetica', 'italic'); doc.setFontSize(12);
        const quoteLines = doc.splitTextToSize(`"${analysis.quote}"`, 182);
        doc.text(quoteLines, 14, y);

        doc.save(`Daily-Report-Mohammed-${dateStr}.pdf`);
        clippySpeak("Your PDF report has been generated!");

    } catch (e) {
        console.error("PDF Generation Failed during execution:", e);
        clippySpeak("Oops! Something went wrong generating the PDF report. Check the console?");
        alert("PDF Generation Failed. See console for details.");
    }
}


// =================================================================
// ðŸ”¥ INIT (Assign Elements & Attach Listeners) ðŸ”¥
// =================================================================
document.addEventListener('DOMContentLoaded', () => {

    // Assign DOM Elements Safely
    listEl = document.getElementById('list');
    newTaskEl = document.getElementById('newTask');
    addBtn = document.getElementById('addBtn');
    resetAllBtn = document.getElementById('resetAllBtn');
    emptyMessageEl = document.getElementById('emptyMessage');
    statusTotalEl = document.getElementById('status-total');
    statusSaveEl = document.getElementById('status-save');
    dreadTaskNameEl = document.getElementById('dread-task-name');
    allCounterButtons = document.querySelectorAll('.counter-fieldset button');
    logTextareaEl = document.getElementById('emergency-log');
    emergencyLogLegendEl = document.getElementById('emergency-log-legend');
    soundTada = document.getElementById('sound-tada');
    soundError = document.getElementById('sound-error');
    addTaskFieldset = document.getElementById('add-task-fieldset');
    progressBarContainer = document.getElementById('progress-bar-container');
    dreadAnalysisFieldset = document.getElementById('dread-analysis-fieldset');
    taskListLegendEl = document.getElementById('task-list-legend');

    logonScreenEl = document.getElementById('logon-screen');
    logonBtnEl = document.getElementById('logon-ok');
    reportBtnEl = document.getElementById('report-panel-btn');
    clippyBtnEl = document.getElementById('clippy-panel-btn');
    resetTodayBtnEl = document.getElementById('reset-today-panel-btn');

    historyDateInput = document.getElementById('history-date-input');
    historyLoadBtn = document.getElementById('history-load-btn');
    historyTodayBtn = document.getElementById('history-today-btn');

    // Add IDs if missing (redundant but safe)
    const progressBarDiv = document.getElementById('v-linear'); if (progressBarDiv && !progressBarDiv.id) progressBarDiv.id = 'progress-bar-container'; progressBarContainer = document.getElementById('progress-bar-container');
    const taskListFieldset = document.getElementById('task-list-fieldset'); const taskListLegend = taskListFieldset ? taskListFieldset.querySelector('legend') : null; if(taskListLegend && !taskListLegend.id) taskListLegend.id = 'task-list-legend'; taskListLegendEl = document.getElementById('task-list-legend');


    // Load Clippy Agent (check library existence first)
    if (typeof clippy !== 'undefined') {
        clippy.load('Clippy', (agent) => {
            clippyAgent = agent;
            console.log("Clippy loaded successfully!");
            if (clippyBtnEl) {
                clippyBtnEl.disabled = false;
                clippyBtnEl.addEventListener('click', showClippyAnalysis);
            }
        }, (error) => {
             console.error("Clippy failed to load:", error);
             if (clippyBtnEl) clippyBtnEl.disabled = true;
        });
    } else {
        console.error("Clippy library not found! Button will be disabled.");
        if (clippyBtnEl) clippyBtnEl.disabled = true;
    }

    // Attach Event Listeners Safely
    if (logonBtnEl) { logonBtnEl.addEventListener('click', () => { if (logonScreenEl) logonScreenEl.style.display = 'none'; }); } else { console.warn("Logon button missing."); }
    if (reportBtnEl) { reportBtnEl.addEventListener('click', generateDailyReport); } else { console.warn("Report button missing."); }
    if (resetTodayBtnEl) { resetTodayBtnEl.addEventListener('click', handleResetTodayCounters); } else { console.warn("Reset Today button missing."); }
    if (addBtn) { addBtn.addEventListener('click', handleAddTask); } else { console.warn("Add Task button missing."); }
    if (newTaskEl) { newTaskEl.addEventListener('keydown', e => { if(e.key==='Enter') handleAddTask(); }); } else { console.warn("New task input missing."); }
    if (resetAllBtn) { resetAllBtn.addEventListener('click', handleResetAll); } else { console.warn("Reset All button missing."); }
    if (historyLoadBtn && historyDateInput) {
        historyLoadBtn.addEventListener('click', () => {
            const date = historyDateInput.value;
            if (!date) { clippySpeak("Please select a date first."); return; }
            isViewingHistory = true;
            const filteredTasks = tasks.filter(task => task.createdDate === date);
            renderList(filteredTasks); // Render filtered tasks first
            counter_listenForChanges(date); // Then load counters (triggers updateCounterUI)
            clippySpeak(`Loading data for ${date}...`);
        });
    } else { console.warn("History Load button or date input missing."); }

    if (historyTodayBtn) {
        historyTodayBtn.addEventListener('click', () => {
            isViewingHistory = false;
            historyDateInput.value = '';
            renderList(); // Render full task list
            counter_listenForChanges(null); // Load today's data (triggers updateCounterUI)
            clippySpeak("Back to today's view!");
        });
    } else { console.warn("History Today button missing."); }

    // Start Firebase Listeners (only if db initialized successfully)
    if (firebaseInitialized && db) {
        listenForTasks();
        counter_listenForChanges(null); // Initial load for today
        updateStatus("Ready"); // Set initial status
    } else {
        // Firebase failed, update status bar and disable UI
        updateStatus('DB Connection Error!');
        console.error("Firebase DB object not initialized. App functionality limited.");
         const elementsToDisable = [addBtn, resetAllBtn, reportBtnEl, clippyBtnEl, resetTodayBtnEl, historyLoadBtn, newTaskEl];
         elementsToDisable.forEach(el => { if (el) el.disabled = true; });
         if (allCounterButtons) allCounterButtons.forEach(btn => btn.disabled = true);
         // Show a message in the task list area
         if(listEl) listEl.innerHTML = '<li><span class="txt" style="color: red; font-weight: bold;">Database Connection Failed. Please check internet and refresh.</span></li>';
    }
});
</script>
</body>
</html>
