<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>mohammed tasks</title>
<meta name="theme-color" content="#c0c0c0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://unpkg.com/clippyjs@0.0.3/dist/clippy.css" media="all">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://unpkg.com/clippyjs@0.0.3/dist/clippy.min.js"></script>


<style>
  /* Styles include Tabs, Settings, Notes, Quotes, Archive */
  :root{--bg:#c0c0c0;--fg:#000000;--accent:#000080;--accent-fg:#ffffff;--line-dark:#808080;--line-medium:#a0a0a0;--line-light:#ffffff;--input-fill:#ffffff;--font:'Tahoma', 'Arial', sans-serif;--progress-color:#008040;--subtle: #d0d0d0;--taskbar-green: #008080;}
  *{box-sizing:border-box;font-family: var(--font);font-size: 10pt;transition: none !important;}
  html,body{margin:0; background:var(--taskbar-green);}
  body.theme-grey { --taskbar-green: #808080; } /* Grey theme */
  body.theme-teal { --taskbar-green: #008080; } /* Teal theme */

  .wrap{max-width:400px;margin: 40px auto;padding:0;background: var(--bg);box-shadow: 6px 6px 0 var(--line-dark);position: relative;}
  .window {border: 1px solid; border-color: var(--fg) var(--line-light) var(--line-light) var(--fg); padding: 2px; background: var(--bg);}
  .window-inner {border: 1px solid; border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark); padding: 1px; background: var(--bg);}
  .title-bar {background: linear-gradient(90deg, var(--accent) 0%, #1084d8 100%); color: var(--accent-fg); padding: 3px 6px; font-size: 11pt; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--fg);}
  .title-bar-text { flex: 1; padding-left: 8px; display: flex; align-items: center; gap: 6px; }
  .title-bar-controls button {background: var(--bg); border: 1px solid; border-color: var(--line-light) var(--line-dark) var(--line-dark) var(--line-light); width: 18px; height: 18px; font-size: 10pt; padding: 0; line-height: 1; cursor: default; font-weight: bold;}
  .title-bar-controls button:active {border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark); padding: 1px 0 0 1px;}
  .main-content { padding: 8px 8px 30px 8px; } /* Add padding for status bar */

  /* Tabs */
  .tabs { display: flex; border-bottom: 1px solid var(--line-dark); background: var(--bg); padding: 3px 3px 0 3px; }
  .tab { padding: 5px 10px; border: 1px solid; border-color: var(--line-light) var(--line-dark) transparent var(--line-light); background: var(--bg); cursor: pointer; margin-bottom: -1px; /* Overlap border */ font-size: 9pt; }
  .tab.active { border-color: var(--line-light) var(--line-dark) var(--bg) var(--line-light); /* Bottom border matches bg */ z-index: 1; position: relative; font-weight: bold; }
  .tab:not(.active):hover { background: var(--subtle); }
  .tab-content { display: none; padding: 10px; border: 1px solid; border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark); border-top: none; }
  .tab-content.active { display: block; }

  fieldset {border: 1px solid; border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark); padding: 10px; margin: 8px 0; background: var(--bg); box-shadow: 1px 1px 0 var(--line-light) inset, -1px -1px 0 var(--line-dark) inset;}
  legend {background: var(--bg); padding: 0 6px; font-weight: bold; color: var(--accent); margin-left: 5px; font-size: 9pt;} /* Smaller legend */
  .controls{display:flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 8px;}
  input[type="text"], input[type="number"], input[type="date"], textarea, select {border: 1px solid; border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark); background: var(--input-fill); color: var(--fg); padding: 4px 6px; font-size: 10pt; outline: none; box-shadow: 1px 1px 0 var(--line-dark) inset, -1px -1px 0 var(--line-light) inset; }
  textarea { width: 100%; box-sizing: border-box; font-family: var(--font); }
  input:focus, .btn:focus, .del:focus, input[type="checkbox"]:focus, textarea:focus, select:focus { outline: 1px dashed var(--fg); outline-offset: -2px; }
  .btn {border: 1px solid; border-color: var(--line-light) var(--line-dark) var(--line-dark) var(--line-light); background: var(--bg); color: var(--fg); padding: 5px 12px; cursor: pointer; box-shadow: none; line-height: 1; font-size: 10pt; flex-shrink: 0;}
  .btn:active {border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark); padding: 6px 11px 4px 13px;} /* Simulate push */
  .btn.ghost { background: transparent; box-shadow: none; border-color: transparent; }
  .btn.ghost:active { padding: 6px 11px 4px 13px; }
  .btn:hover { /* No default hover for classic buttons */ }
  .btn:disabled { color: var(--line-dark); text-shadow: 1px 1px var(--line-light); cursor: not-allowed;}
  .muted{color:var(--line-dark);font-size:9pt; padding: 0 4px;} /* Adjusted muted color */
  .toolbar {display: flex; gap: 4px; padding: 0; margin-top: 8px;}
  .toolbar button { flex: 1; }
  .task-list-box {border: 1px solid; border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark); background: var(--input-fill); padding: 0; min-height: 100px; margin-top: 8px; box-shadow: 1px 1px 0 var(--line-dark) inset, -1px -1px 0 var(--line-light) inset;}
  ul{list-style:none;padding:0;margin:0}
  li{display:flex; align-items:center; gap:8px; padding: 4px 8px;background: var(--input-fill); color: var(--fg); margin: 0;border-bottom: 1px solid var(--line-medium);cursor: default;}
  li:last-child { border-bottom: none; }
  li:hover { background: var(--subtle); }
  li.done { color: var(--line-dark); opacity: 0.9; }
  li.done .txt { text-decoration: line-through; }
  .txt{flex:1; line-height:1.4; font-size: 10pt; min-width: 0; word-break: break-word;} /* Allow long words to break */
  input[type="checkbox"]{appearance: none; width: 13px; height: 13px;border: 1px solid var(--fg); background: var(--input-fill);box-shadow: 1px 1px 0 var(--line-dark) inset, -1px -1px 0 var(--line-light) inset;margin: 0; padding: 0; display: grid; place-items: center; flex-shrink: 0;cursor: pointer;}
  input[type="checkbox"]:checked::after { content: 'âœ“'; color: var(--fg); font-size: 10pt; line-height: 0.8; }
  input[type="checkbox"]:active { box-shadow: 1px 1px 0 var(--line-light) inset, -1px -1px 0 var(--line-dark) inset; }
  input[type="checkbox"]:disabled { background: var(--subtle); box-shadow: none; cursor: not-allowed; }
  input[type="checkbox"]:disabled::after { color: var(--line-dark); }
  .del{appearance:none; border:0; background:transparent; color:var(--line-dark); font-size:10pt;cursor: pointer; padding: 0 4px; line-height:1; flex-shrink: 0;}
  .del:hover{color:red;}
  .del:disabled { color: var(--line-medium); cursor: not-allowed; }
  .linear-progress-box { margin-top: 8px; }
  .head{display:flex;justify-content:space-between;align-items:center;margin:0 0 4px 0}
  .big{font-weight:bold; font-size: 11pt;}
  .progress{height:14px; background: var(--line-dark);border: 1px solid; border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark); overflow:hidden; padding: 2px;}
  .bar{ height:100%; width:0; background: var(--progress-color); }
  .status-bar {border-top: 1px solid var(--line-light);display: flex; align-items: center;padding: 0 0;background: var(--bg);height: 24px;position: absolute;bottom: 0; left: 0; right: 0; width: 100%;} /* Adjusted for tabs */
  .start-btn {background: var(--bg);border: 1px solid; border-color: var(--line-light) var(--line-dark) var(--line-dark) var(--line-light);font-weight: bold;padding: 1px 6px 0 6px;margin: 2px; height: calc(100% - 4px); line-height: 1.6; font-size: 11pt;color: var(--fg);cursor: pointer;box-shadow: none;flex-shrink: 0;}
  .start-btn:active {border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark);padding: 2px 5px 0 7px;}
  .separator {height: calc(100% - 4px); width: 1px; background: var(--line-dark); border-right: 1px solid var(--line-light); margin: 2px;}
  .status-panel-group {display: flex;margin-left: auto;align-items: center;height: 100%;}
  .status-panel {border: 1px solid var(--line-dark); border-left-color: var(--line-light); border-top-color: var(--line-light);padding: 0 8px; line-height: 2.1; font-size: 9pt; flex-shrink: 0; min-width: 50px; height: calc(100% - 4px); margin: 2px 0 2px 2px; text-align: center;}
  /* Counters */
  .counters-container {display: grid;grid-template-columns: 1fr 1fr 1fr;gap: 8px;padding: 0 0 8px 0;}
  .counter-fieldset {text-align: center;padding: 8px 5px 5px 5px;}
  .counter-fieldset legend {padding: 0 4px;font-size: 9pt;}
  .counter-fieldset h1 {font-size: 2.2rem;margin: 0 0 5px 0;font-weight: bold;color: #000;line-height: 1;}
  .counter-fieldset button {font-size: 1.1rem;font-weight: bold;width: 100%;height: 28px;padding: 0;}
  .counter-fieldset button:disabled {color: var(--line-dark);text-shadow: 1px 1px var(--line-light);cursor: not-allowed;}
  .emergency-fieldset {background-color: #CC4444;color: #FFFFFF;}
  .emergency-fieldset h1 {color: #FFFFFF;}
  .emergency-fieldset legend {color: #FFFFFF;background: #CC4444;}
  hr {border: 0;border-top: 1px solid var(--line-dark);border-bottom: 1px solid var(--line-light);margin: 15px 0;}
  .info-box fieldset {margin-top: 0;padding: 8px;}
  .info-box legend {font-size: 9pt;margin-left: 2px;}
  #emergency-log {width: 100%;box-sizing: border-box;font-family: var(--font);font-size: 9pt;background: var(--input-fill);color: var(--fg);border: 1px solid; border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark);box-shadow: 1px 1px 0 var(--line-dark) inset, -1px -1px 0 var(--line-light) inset; min-height: 60px;} /* Min height for log */
  .status-panel-btn {cursor: pointer;border: 1px solid var(--line-light);border-right-color: var(--line-dark);border-bottom-color: var(--line-dark);}
  .status-panel-btn:active {border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark);}
  .status-panel-btn:disabled { cursor: not-allowed; opacity: 0.6; } /* Style disabled panel buttons */
  #clippy-panel-btn {font-size: 1.2rem;line-height: 1.5;padding: 0 6px;min-width: 30px;}
  #report-panel-btn {padding: 0 6px;}
  #reset-today-panel-btn {padding: 0 6px;}
  #logon-screen {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: var(--taskbar-green);display: flex;justify-content: center;align-items: center;z-index: 1000;}
  #logon-window {width: 350px;padding-bottom: 10px;}
  #logon-content {padding: 20px;display: flex;align-items: center;gap: 15px;}
  #logon-content i {font-size: 48px;color: var(--accent);}
  #logon-buttons {text-align: center;padding: 0 20px;}
  #logon-ok {width: 100px;}
  .dread-btn {appearance: none; border: 0; background: transparent;font-size: 1.1rem; cursor: pointer; padding: 0 4px; line-height: 1; flex-shrink: 0;}
  .dread-btn:hover { opacity: 0.6; } .dread-btn:active { transform: scale(0.9); }
  .dread-btn:disabled { cursor: not-allowed; opacity: 0.5; }
  .dread-analysis-panel {padding: 5px;font-size: 0.95rem;}
  .dread-analysis-panel .task-name {font-weight: bold;color: var(--accent);}
  .history-controls {display: flex;gap: 8px;align-items: center;}
  .history-controls input[type="date"] {border: 1px solid; border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark); background: var(--input-fill); color: var(--fg); padding: 4px 6px; font-size: 10pt;outline: none; box-shadow: 1px 1px 0 var(--line-dark) inset, -1px -1px 0 var(--line-light) inset; flex: 1; height: 30px;}
  .history-controls button {flex-shrink: 0; height: 30px;}
  /* Settings Tab Styles */
  .setting-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .setting-row label { flex: 0 0 120px; /* Fixed width for labels */ text-align: right; font-size: 9pt;}
  .setting-row input[type="number"], .setting-row input[type="text"], .setting-row select { flex: 1; }
  input[type="checkbox"].settings-checkbox { width: auto; height: auto; box-shadow: none; border: none; /* Simplify checkbox */ margin-right: 5px; vertical-align: middle;}
  /* Quotes Tab Styles */
  #quotes-list li { justify-content: space-between; align-items: center;} /* Align delete button */
  /* Archive Tab Styles */
  #archive-controls { display: flex; gap: 10px; margin-bottom: 10px; align-items: center;} /* Align items */
  #archive-controls label { font-size: 9pt; }
  #archive-controls input[type="date"] { flex: 1; height: 30px;} /* Match height */
  #archive-controls button { height: 30px;} /* Match height */
  #archive-list-box { border: 1px solid; border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark); background: var(--input-fill); padding: 0; min-height: 150px; margin-top: 8px; box-shadow: 1px 1px 0 var(--line-dark) inset, -1px -1px 0 var(--line-light) inset; overflow-y: auto;} /* Added scroll */
  #archive-list li { border-bottom: 1px solid var(--line-medium); align-items: center;} /* Align items */
  #archive-list li .date-stamp { font-size: 8pt; color: var(--line-dark); margin-left: auto; padding-left: 10px; flex-shrink: 0;} /* Prevent shrinking */
  /* Random Quote Style */
  #random-quote-display { border: 1px solid var(--line-dark); border-left-color: var(--line-light); border-top-color: var(--line-light); padding: 5px 8px; font-size: 9pt; margin: 10px 0; background: var(--input-fill); font-style: italic; min-height: 2.5em; /* Ensure space */ text-align: center; color: var(--line-dark); }


  @media (max-width: 768px) {
      .wrap {max-width: 100%;margin: 0;height: 100vh;box-shadow: none;}
      .main-content { padding: 4px 4px 30px 4px; }
      .tab { padding: 4px 6px; font-size: 8pt; }
      .tab-content { padding: 6px; }
      .setting-row { flex-direction: column; align-items: stretch; gap: 4px; margin-bottom: 8px;}
      .setting-row label { text-align: left; margin-bottom: 2px;}
      .controls { flex-direction: column; align-items: stretch; gap: 4px; }
      .controls > * { width: 100%; }
      .controls label { flex: none; width: 100%; padding-bottom: 2px; }
      .toolbar button { flex: 1; }
      .task-list-box { min-height: 150px; } /* Adjusted height */
      li { padding: 6px 8px; }
      .status-bar { width: 100%; left: 0; right: 0; bottom: 0; position: fixed; }
      .status-panel-group { margin-left: auto; }
      .counters-container {gap: 4px;padding: 4px 0 4px 0;}
      .counter-fieldset {padding: 6px 4px 4px 4px;}
      .counter-fieldset h1 {font-size: 1.8rem;}
      .counter-fieldset button {height: 24px;font-size: 1rem;}
      .counter-fieldset legend {font-size: 8pt;}
      .info-box p, .info-box .sunken-panel {font-size: 8pt;}
      .history-controls {flex-direction: column;align-items: stretch;}
      .history-controls input[type="date"] {margin-bottom: 4px;}
      #archive-controls { flex-direction: column; align-items: stretch; gap: 4px; }
  }
</style>
</head>
<body class="theme-grey"> <div id="logon-screen">
      <div class="window" id="logon-window"><div class="title-bar"><div class="title-bar-text">Logon</div></div><div id="logon-content"><i class="fas fa-user-circle"></i><div><p style="margin: 0 0 5px 0;">Welcome back, <strong>Mohammed</strong>.</p><p style="margin: 0;">Click OK to load.</p></div></div><div id="logon-buttons"><button class="btn" id="logon-ok">OK</button></div></div>
  </div>

  <main class="wrap window">
    <div class="window-inner">
      <div class="title-bar">
          <div class="title-bar-text"><i class="fas fa-user-circle"></i><span>mohammed tasks</span></div>
          <div class="title-bar-controls"><button title="Minimize">_</button><button title="Maximize">â–¡</button><button title="Close">X</button></div>
      </div>

      <div class="tabs">
          <div class="tab active" data-tab="main-tab">Main</div>
          <div class="tab" data-tab="settings-tab">Settings</div>
          <div class="tab" data-tab="notes-tab">Notes</div>
          <div class="tab" data-tab="quotes-tab">Quotes</div>
          <div class="tab" data-tab="archive-tab">Archive</div>
          <div class="tab" data-tab="about-tab">About</div>
      </div>

      <div class="main-content">

          <div id="main-tab" class="tab-content active">
              <div class="counters-container">
                  <fieldset class="counter-fieldset"><legend id="counter-label-achievements">Achievements</legend><h1 id="achievements-count">0</h1><button class="btn">+</button></fieldset>
                  <fieldset class="counter-fieldset"><legend id="counter-label-neutral">Neutral</legend><h1 id="neutral-count">0</h1><button class="btn">+</button></fieldset>
                  <fieldset class="counter-fieldset emergency-fieldset"><legend id="counter-label-emergency">Emergency</legend><h1 id="emergency-count">0</h1><button class="btn">+</button></fieldset>
              </div>
              <div class="info-box" style="padding: 0; margin: 0;"><fieldset><legend id="emergency-log-legend">Today's Log</legend><div style="padding: 5px;"><textarea id="emergency-log" readonly rows="3"></textarea></div></fieldset></div>
              <div id="random-quote-display">(...)</div>
              <hr>
              <fieldset id="add-task-fieldset"><legend>Add New Task</legend><div class="controls"><label for="newTask" style="flex: 0 0 100px;">Task:</label><input id="newTask" type="text" placeholder="Descriptionâ€¦"/></div><div class="toolbar"><button class="btn" id="addBtn"><i class="fas fa-plus"></i> Add</button><button class="btn ghost" id="resetAllBtn" title="Delete ALL tasks & Today's Counters"><i class="fas fa-trash-alt"></i> Reset All</button></div></fieldset>
              <div id="progress-bar-container" class="linear-progress-box"><div class="head"><div><span class="big" id="pct1">0%</span> <span class="muted">Progress</span></div><div class="muted"><span id="done1">0</span>/<span id="total1">0</span> Tasks</div></div><div class="progress"><div id="bar1" class="bar"></div></div></div>
              <fieldset id="dread-analysis-fieldset" class="info-box" style="padding: 8px; margin-top: 15px;"><legend>Dread Analysis</legend><div class="dread-analysis-panel"><span>Most Evaded:</span> <span id="dread-task-name" class="task-name">(None)</span></div></fieldset>
              <fieldset id="task-list-fieldset"><legend id="task-list-legend">Current Tasks</legend><div class="task-list-box"><ul id="list"></ul></div><div id="emptyMessage" class="muted">No tasks.</div></fieldset>
          </div>

          <div id="settings-tab" class="tab-content">
              <fieldset><legend>General</legend>
                  <div class="setting-row"><label for="setting-goal">Daily Goal:</label><input type="number" id="setting-goal" min="1"></div>
                  <div class="setting-row"><label for="setting-sounds"> Sounds:</label><input type="checkbox" id="setting-sounds" class="settings-checkbox"> </div>
                  <div class="setting-row"><label for="setting-theme">Theme:</label><select id="setting-theme"><option value="theme-grey">Classic Grey</option><option value="theme-teal">Teal Green</option></select></div>
              </fieldset>
              <fieldset><legend>Labels</legend>
                  <div class="setting-row"><label for="setting-label-ach">Ach:</label><input type="text" id="setting-label-ach"></div>
                  <div class="setting-row"><label for="setting-label-neu">Neu:</label><input type="text" id="setting-label-neu"></div>
                  <div class="setting-row"><label for="setting-label-emg">Emg:</label><input type="text" id="setting-label-emg"></div>
              </fieldset>
              <button class="btn" id="save-settings-btn" style="width: 100%;">Save</button>
          </div>

          <div id="notes-tab" class="tab-content">
              <fieldset><legend>Notes (<span id="notes-date"></span>)</legend><textarea id="notes-textarea" rows="15" placeholder="..."></textarea><p class="muted">Auto-saved.</p></fieldset>
          </div>

          <div id="quotes-tab" class="tab-content">
              <fieldset><legend>Add Quote</legend><div class="controls"><input type="text" id="new-quote-input" placeholder="..." style="flex: 1;"><button class="btn" id="add-quote-btn"><i class="fas fa-plus"></i> Add</button></div></fieldset>
              <fieldset><legend>My Quotes</legend><div class="task-list-box" style="min-height: 200px;"><ul id="quotes-list"></ul></div></fieldset>
          </div>

          <div id="archive-tab" class="tab-content">
              <fieldset><legend>Completed Tasks Archive</legend>
                  <div id="archive-controls"><label>From:</label><input type="date" id="archive-start-date"><label>To:</label><input type="date" id="archive-end-date"><button class="btn" id="load-archive-btn">Load</button></div>
                  <div id="archive-list-box"><ul id="archive-list"></ul></div><p id="archive-empty" class="muted">No completed tasks found.</p>
              </fieldset>
          </div>

          <div id="about-tab" class="tab-content">
              <fieldset><legend>About</legend><p>Mohammed Tasks - v2.3</p><ul><li>Counters</li><li>Tasks</li><li>Logs</li><li>Notes/Quotes</li><li>Report/Clippy</li><li>Settings</li><li>Archive</li></ul><p>Synced via Firebase.</p></fieldset>
          </div>

      </div> <div class="status-bar">
          <button class="start-btn">Start</button><div class="separator"></div>
          <div class="status-panel" style="flex-grow: 1; margin: 2px 0; text-align: left; min-width: 0;">mohammed tasks</div>
          <div class="status-panel-group">
            <div class="status-panel status-panel-btn" id="clippy-panel-btn" role="button" title="Analysis" disabled>ðŸ“Ž</div>
            <div class="status-panel status-panel-btn" id="report-panel-btn" role="button" title="Report"><i class="fas fa-print"></i> Report</div>
            <div class="status-panel status-panel-btn" id="reset-today-panel-btn" role="button" title="Reset Today"><i class="fas fa-undo"></i> Reset Today</div>
            <div class="status-panel" id="status-total">Total: 0</div>
            <div class="status-panel" id="status-save">Loading...</div>
          </div>
      </div>
    </div> </main> <audio id="sound-tada" src="https://www.myinstants.com/media/sounds/tada.mp3" preload="auto"></audio>
  <audio id="sound-error" src="https://www.myinstants.com/media/sounds/windows-xp-error.mp3" preload="auto"></audio>

<script>
// =================================================================
// ðŸ”¥ FIREBASE INITIALIZATION & CONFIG ðŸ”¥
// =================================================================
const firebaseConfig = { /* Your Config */
  apiKey: "AIzaSyBvpcUP-DmXH82WHgm4ZLHezeBFaaxMnCE", authDomain: "mohammedtasksapp.firebaseapp.com", databaseURL: "https://mohammedtasksapp-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "mohammedtasksapp", storageBucket: "mohammedtasksapp.appspot.com", messagingSenderId: "271781862481", appId: "1:271781862481:web:dfd63b2c4b4a8d74ad2c70"
};

let db = null; let firebaseInitialized = false;
try {
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); console.log("Firebase initialized."); } else { firebase.app(); console.log("Firebase already initialized."); }
    db = firebase.database(); firebaseInitialized = true;
} catch (e) { console.error("Firebase init failed:", e); firebaseInitialized = false; }

// =================================================================
// ðŸ”¥ GLOBAL VARIABLES & DOM ELEMENTS ðŸ”¥
// =================================================================
let todayCounterRef = null; let currentCounters = { achievements: 0, neutral: 0, emergency: 0, emergencyLog: [] };
let isViewingHistory = false; let tasks = []; let clippyAgent = null; let quotes = []; let currentSettings = { dailyGoal: 10, soundsEnabled: true, theme: 'theme-grey', labels: { achievements: 'Achievements', neutral: 'Neutral', emergency: 'Emergency' } }; let notesRef = null; let currentNote = ""; let settingsRef = null; let quotesRef = null;

// DOM Elements
let listEl, newTaskEl, addBtn, resetAllBtn, emptyMessageEl, statusTotalEl, statusSaveEl;
/* REMOVED historyDateInput, historyLoadBtn, historyTodayBtn - Replaced by Archive Tab */
let dreadTaskNameEl; let allCounterButtons;
let reportBtnEl, clippyBtnEl, resetTodayBtnEl;
let logTextareaEl, emergencyLogLegendEl; let soundTada, soundError;
let logonScreenEl, logonBtnEl;
let addTaskFieldset, progressBarContainer, dreadAnalysisFieldset, taskListLegendEl;
let tabs, tabContents;
let settingGoalInput, settingSoundsCheckbox, settingThemeSelect;
let settingLabelAchInput, settingLabelNeuInput, settingLabelEmgInput, saveSettingsBtn;
let notesTextarea, notesDateSpan;
let newQuoteInput, addQuoteBtn, quotesListEl;
let randomQuoteDisplayEl;
let archiveStartDateInput, archiveEndDateInput, loadArchiveBtn, archiveListEl, archiveEmptyMsg;

// =================================================================
// ðŸ”¥ HELPER FUNCTIONS (UTILS) ðŸ”¥
// =================================================================
function getTodayDateString() { const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function updateStatus(message, isError = false) { if (statusSaveEl) { statusSaveEl.textContent = message; if (!isError) { setTimeout(() => { if (statusSaveEl && statusSaveEl.textContent === message) statusSaveEl.textContent = 'Ready'; }, 2500); } } }
function clippySpeak(message, hold = false) { if (clippyAgent && !clippyAgent.busy()) { clippyAgent.speak(message, hold); } else { console.log("Clippy fallback/busy:", message); } }
function checkPdfLibraries() { const ready = typeof window.jspdf !== 'undefined' && typeof window.jspdf.jsPDF === 'function' && typeof window.jspdf.plugin !== 'undefined' && typeof window.jspdf.plugin.autotable === 'function'; if (!ready) { console.error("PDF Libs Check Failed!"); let msg = "Error: PDF Libs Missing/Not Ready. Check internet & refresh (Ctrl+Shift+R). Wait a bit?"; clippySpeak(msg); updateStatus("PDF Lib Error", true); alert(msg); } return ready; }


// =================================================================
// ðŸ”¥ TABS LOGIC ðŸ”¥
// =================================================================
function activateTab(tabId) {
    if (!tabs || !tabContents) return;
    tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabId));
    tabContents.forEach(content => content.classList.toggle('active', content.id === tabId));
    if (tabId === 'notes-tab') listenForNotes(); // Load today's notes
    if (tabId === 'main-tab') displayRandomQuote(); // Refresh random quote
}

// =================================================================
// ðŸ”¥ COUNTER LOGIC (Firebase) ðŸ”¥
// =================================================================
function counter_listenForChanges() { // Simplified: Always listens to Today
    if (!db) { console.warn("DB not ready."); return; }
    const today = getTodayDateString();
    const newRefPath = 'dailyCounters/' + today;
    const newRef = db.ref(newRefPath);

    // If already listening to today, exit
    if (todayCounterRef && todayCounterRef.toString() === newRef.toString()) return;

    // If listening to something else (shouldn't happen now), detach
    if (todayCounterRef) todayCounterRef.off('value');

    console.log("Attaching listener for Today's Counters:", newRefPath);
    todayCounterRef = newRef;
    todayCounterRef.on('value', (snapshot) => {
        const data = snapshot.val();
        currentCounters = data ? { ...data, emergencyLog: data.emergencyLog || [] } : { achievements: 0, neutral: 0, emergency: 0, emergencyLog: [] };
        if (!data) { // Set defaults for a new day
            console.log("Setting default counters for today.");
            todayCounterRef.set(currentCounters).catch(e => console.error("Init counter set fail:", e));
        }
        updateCounterUI();
    }, (error) => { console.error(`Counter Read Fail ${today}:`, error); updateStatus('Counter Sync Err', true); currentCounters = { achievements: 0, neutral: 0, emergency: 0, emergencyLog: [] }; updateCounterUI(); });
}

function updateCounterUI() {
    // Only update UI elements, no logic here
    const achEl=document.getElementById('achievements-count'); const neuEl=document.getElementById('neutral-count'); const emgEl=document.getElementById('emergency-count');
    const achLabelEl=document.getElementById('counter-label-achievements'); const neuLabelEl=document.getElementById('counter-label-neutral'); const emgLabelEl=document.getElementById('counter-label-emergency');
    if(achEl)achEl.innerText=currentCounters.achievements||0; if(neuEl)neuEl.innerText=currentCounters.neutral||0; if(emgEl)emgEl.innerText=currentCounters.emergency||0;
    if(achLabelEl)achLabelEl.textContent=currentSettings.labels.achievements||'Achievements'; if(neuLabelEl)neuLabelEl.textContent=currentSettings.labels.neutral||'Neutral'; if(emgLabelEl)emgLabelEl.textContent=currentSettings.labels.emergency||'Emergency';
    const logData=currentCounters.emergencyLog||[]; if(logTextareaEl){logTextareaEl.value=logData.length>0?logData.join('\n'):'(No logs)';logTextareaEl.scrollTop=logTextareaEl.scrollHeight;}
    if(emergencyLogLegendEl){emergencyLogLegendEl.textContent="Today's Log";} // Legend is always Today's
    // Buttons are never disabled now
    if(allCounterButtons)allCounterButtons.forEach(btn=>btn.disabled=false);
}

function counter_increment(type) {
    if (!db || !todayCounterRef) { clippySpeak("DB error."); return; }
    // History check removed as we always operate on today's ref now

    let finalReason = ""; let updates = {};
    if (type === 'emergency') {
        let reasonInput = prompt(`EMERGENCY (${currentSettings.labels.emergency}):\n\n1. Social Media\n2. Phone\n3. Procrastination\n4. Other`, "");
        if (reasonInput === null) return;
        finalReason = reasonInput==="1"?"Social Media":reasonInput==="2"?"Phone/Calls":reasonInput==="3"?"Procrastination":reasonInput==="4"?(prompt("Specify:","")||"Other"):reasonInput.trim()||"Other";
        const currentLog = Array.isArray(currentCounters.emergencyLog) ? [...currentCounters.emergencyLog] : [];
        currentLog.push(finalReason); updates.emergencyLog = currentLog;
        if (currentSettings.soundsEnabled && soundError) soundError.play().catch(e => console.warn("Audio fail:", e));
    }
    todayCounterRef.child(type).transaction((c) => (c || 0) + 1, (err, comm, snap) => {
        if(err){console.error('Count Tx fail!', err); updateStatus('Count Save Err', true);}
        else if(comm){const nC=snap.val(); if(type==='achievements' && nC >= currentSettings.dailyGoal){clippySpeak(`Goal reached! ${nC} ${currentSettings.labels.achievements}!`);}}
    });
    if (updates.emergencyLog) { todayCounterRef.update({ emergencyLog: updates.emergencyLog }).catch(e => { console.error("Log update fail:", e); updateStatus('Log Save Err', true); }); }
}

// =================================================================
// ðŸ”¥ TASK APP LOGIC (Firebase) ðŸ”¥
// =================================================================
const tasksRef = db ? db.ref('tasks') : null;
// ... (listenForTasks, addTaskToDB, updateTaskStatus, incrementDreadCount, deleteTask, deleteAllTasks - unchanged but check db/tasksRef) ...
function listenForTasks(){if(!tasksRef)return; tasksRef.on('value',(s)=>{const d=s.val();tasks=[];if(d){for(let id in d){tasks.push({...d[id],id:id,dreadCount:d[id].dreadCount||0});}} renderList(); updateLinearView();updateDreadAnalysis();updateStatus('Synced');},(e)=>{console.error("Task Read Fail:",e);updateStatus('Task Sync Err',true);});} // Always render full list now
function addTaskToDB(t){if(!tasksRef)return;const nT={text:t,done:false,createdDate:getTodayDateString(),dreadCount:0};tasksRef.push(nT).catch((e)=>{console.error("Task Write Fail:",e);updateStatus('Write Err',true);});}
function updateTaskStatus(id,isDone){if(!tasksRef)return;tasksRef.child(id).update({done:isDone}).catch((e)=>{console.error("Task Update Fail:",e);updateStatus('Update Err',true);});if(isDone&&currentSettings.soundsEnabled&&soundTada)soundTada.play().catch(e=>console.warn("Audio fail:",e));}
function incrementDreadCount(id){if(!tasksRef)return;tasksRef.child(id).child('dreadCount').transaction((c)=>(c||0)+1);}
function deleteTask(id){if(!tasksRef)return;tasksRef.child(id).remove().catch((e)=>{console.error("Task Delete Fail:",e);updateStatus('Delete Err',true);});}
function deleteAllTasks(){if(!tasksRef)return;tasksRef.remove().catch((e)=>{console.error("Task Clear Fail:",e);updateStatus('Clear Err',true);});}
// ... (getSortedTasks, renderList, updateDreadAnalysis - simplified, no history check needed in renderList now) ...
function getSortedTasks(a=tasks){return[...a].sort((x,y)=>(y.createdDate||"").localeCompare(x.createdDate||""));}
function renderList() { // Simplified renderList
    const sortedTasks = getSortedTasks();
    if (!listEl) return; listEl.innerHTML = '';
    if (sortedTasks.length === 0) { if (emptyMessageEl) { emptyMessageEl.textContent = "No tasks."; emptyMessageEl.style.display = 'block'; } }
    else { if (emptyMessageEl) emptyMessageEl.style.display = 'none'; }
    sortedTasks.forEach(t => {
        const li=document.createElement('li');if(t.done)li.classList.add('done');
        const cb=document.createElement('input');cb.type='checkbox';cb.checked=t.done;cb.addEventListener('change',()=>{updateTaskStatus(t.id,cb.checked);});
        const span=document.createElement('span');span.className='txt';span.textContent=t.text;
        const dr=document.createElement('button');dr.className='dread-btn';dr.title=`Dread (${t.dreadCount||0})`;dr.innerHTML='ðŸ˜°';dr.addEventListener('click',()=>{incrementDreadCount(t.id);});
        const del=document.createElement('button');del.className='del';del.innerHTML='<i class="fas fa-trash"></i>';del.addEventListener('click',()=>{deleteTask(t.id);});
        li.appendChild(cb);li.appendChild(span);li.appendChild(dr);li.appendChild(del);listEl.appendChild(li);
    });
    if (statusTotalEl) statusTotalEl.textContent = `Total: ${tasks.length}`;
}
function updateDreadAnalysis(){/* ... same ... */ if(!dreadTaskNameEl)return;const p=tasks.filter(t=>!t.done);if(p.length===0){dreadTaskNameEl.textContent='(None)';return;} const m=p.sort((a,b)=>{const d=(b.dreadCount||0)-(a.dreadCount||0);return d!==0?d:(b.createdDate||"").localeCompare(a.createdDate||"");})[0];dreadTaskNameEl.textContent=(m&&m.dreadCount>0)?`${m.text} (${m.dreadCount})`:'(None)';}
// ... (handleAddTask, handleResetAll, handleResetTodayCounters, getProgress, updateLinearView - unchanged) ...
function handleAddTask(){const t=(newTaskEl.value||'').trim();if(!t){clippySpeak("Enter task!");return;} addTaskToDB(t);newTaskEl.value='';newTaskEl.focus();}
function handleResetAll(){if(!confirm('SURE?\n\nDelete ALL tasks?\nReset today\'s counters & log?'))return;deleteAllTasks();if(todayCounterRef){const d={achievements:0,neutral:0,emergency:0,emergencyLog:[]};todayCounterRef.set(d).then(()=>{clippySpeak("All reset.");updateStatus("All Reset");}).catch(e=>console.error("Counter reset fail:",e));}} // Reset today's counter always
function handleResetTodayCounters(){if(!confirm('Reset Today\'s Counters & Log?\n(Tasks NOT affected)'))return;if(todayCounterRef){const d={achievements:0,neutral:0,emergency:0,emergencyLog:[]};todayCounterRef.set(d).then(()=>{clippySpeak("Today's counters reset.");updateStatus("Counters Reset");}).catch(e=>{console.error("Counter reset fail:",e);updateStatus('Reset Error',true);});}}
function getProgress(){const t=tasks.length;const d=tasks.filter(x=>x.done).length;const p=t?Math.round((d/t)*100):0;return{total:t,done:d,pct:p};}
function updateLinearView(){const{total,done,pct}=getProgress();const b=document.getElementById('bar1');const pE=document.getElementById('pct1');const dE=document.getElementById('done1');const tE=document.getElementById('total1');if(b)b.style.width=pct+'%';if(pE)pE.textContent=pct+'%';if(dE)dE.textContent=done;if(tE)tE.textContent=total;const pb=document.querySelector('#v-linear .progress[role="progressbar"]');if(pb)pb.setAttribute('aria-valuenow',pct);}

// =================================================================
// ðŸ”¥ SETTINGS LOGIC (Firebase) ðŸ”¥
// =================================================================
settingsRef = db ? db.ref('settings') : null;
// ... (applySettings, listenForSettings, saveSettings - unchanged but check db/settingsRef) ...
function applySettings(){document.body.className=currentSettings.theme||'theme-grey';updateCounterUI();if(settingGoalInput)settingGoalInput.value=currentSettings.dailyGoal||10;if(settingSoundsCheckbox)settingSoundsCheckbox.checked=currentSettings.soundsEnabled!==false;if(settingThemeSelect)settingThemeSelect.value=currentSettings.theme||'theme-grey';if(settingLabelAchInput)settingLabelAchInput.value=currentSettings.labels?.achievements||'Achievements';if(settingLabelNeuInput)settingLabelNeuInput.value=currentSettings.labels?.neutral||'Neutral';if(settingLabelEmgInput)settingLabelEmgInput.value=currentSettings.labels?.emergency||'Emergency';}
function listenForSettings(){if(!settingsRef){applySettings();return;} settingsRef.on('value',(s)=>{const d=s.val();if(d){currentSettings={dailyGoal:d.dailyGoal||10,soundsEnabled:d.soundsEnabled!==false,theme:d.theme||'theme-grey',labels:{achievements:d.labels?.achievements||'Achievements',neutral:d.labels?.neutral||'Neutral',emergency:d.labels?.emergency||'Emergency'}};console.log("Settings loaded:",currentSettings);}else{console.log("No settings found, using defaults.");settingsRef.set(currentSettings).catch(e=>console.error("Save default settings fail",e));} applySettings();},(e)=>{console.error("Settings Read Fail:",e);updateStatus("Settings Load Err",true);applySettings();});}
function saveSettings(){if(!settingsRef){clippySpeak("DB error.");return;} const nS={dailyGoal:parseInt(settingGoalInput.value)||10,soundsEnabled:settingSoundsCheckbox.checked,theme:settingThemeSelect.value,labels:{achievements:settingLabelAchInput.value||'Achievements',neutral:settingLabelNeuInput.value||'Neutral',emergency:settingLabelEmgInput.value||'Emergency'}};settingsRef.set(nS).then(()=>{updateStatus("Settings Saved");clippySpeak("Settings saved!");currentSettings=nS;applySettings();}).catch(e=>{console.error("Settings save failed:",e);updateStatus("Settings Save Err",true);clippySpeak("Save settings failed.");});}

// =================================================================
// ðŸ”¥ NOTES LOGIC (Firebase) ðŸ”¥
// =================================================================
// ... (listenForNotes, saveNote, debounceSaveNote - unchanged but check db) ...
function listenForNotes(){if(!db)return; const today=getTodayDateString();if(notesRef)notesRef.off('value');notesRef=db.ref('notes/'+today);if(notesDateSpan)notesDateSpan.textContent=today;notesRef.on('value',(s)=>{currentNote=s.val()||"";if(notesTextarea)notesTextarea.value=currentNote;console.log("Note loaded",today);},(e)=>{console.error("Notes Read Fail:",e);updateStatus("Notes Load Err",true);});}
function saveNote(){if(!notesRef)return;const nN=notesTextarea.value||"";if(nN!==currentNote){notesRef.set(nN).then(()=>{console.log("Note saved.");updateStatus("Note Saved");currentNote=nN;}).catch(e=>{console.error("Note save fail:",e);updateStatus("Note Save Err",true);});}}
let noteSaveTimeout; function debounceSaveNote(){clearTimeout(noteSaveTimeout);noteSaveTimeout=setTimeout(saveNote,1500);}

// =================================================================
// ðŸ”¥ QUOTES LOGIC (Firebase) ðŸ”¥
// =================================================================
quotesRef = db ? db.ref('quotes') : null;
// ... (listenForQuotes, renderQuotesList, addQuote, deleteQuote, displayRandomQuote - unchanged but check db/quotesRef) ...
function listenForQuotes(){if(!quotesRef){displayRandomQuote();return;} quotesRef.on('value',(s)=>{const d=s.val();quotes=[];if(d){for(let k in d){quotes.push({id:k,text:d[k].text});}} renderQuotesList();displayRandomQuote();console.log("Quotes loaded:",quotes.length);},(e)=>{console.error("Quotes Read Fail:",e);updateStatus("Quotes Load Err",true);});}
function renderQuotesList(){if(!quotesListEl)return;quotesListEl.innerHTML='';if(quotes.length===0){quotesListEl.innerHTML='<li class="muted">No quotes.</li>';}else{quotes.forEach(q=>{const li=document.createElement('li');const s=document.createElement('span');s.className='txt';s.textContent=q.text;const d=document.createElement('button');d.className='del';d.innerHTML='<i class="fas fa-trash"></i>';d.onclick=()=>deleteQuote(q.id);li.appendChild(s);li.appendChild(d);quotesListEl.appendChild(li);});}}
function addQuote(){if(!quotesRef||!newQuoteInput)return;const t=newQuoteInput.value.trim();if(!t){clippySpeak("Enter quote.");return;} quotesRef.push({text:t}).then(()=>{newQuoteInput.value='';updateStatus("Quote Added");}).catch(e=>{console.error("Add quote fail:",e);updateStatus("Quote Add Err",true);});}
function deleteQuote(id){if(!quotesRef)return;if(confirm("Delete quote?")){quotesRef.child(id).remove().catch(e=>{console.error("Delete quote fail:",e);updateStatus("Quote Delete Err",true);});}}
function displayRandomQuote(){if(!randomQuoteDisplayEl)return;if(quotes.length>0){const i=Math.floor(Math.random()*quotes.length);randomQuoteDisplayEl.textContent=`"${quotes[i].text}"`;}else{randomQuoteDisplayEl.textContent="(Add quotes!)";}}

// =================================================================
// ðŸ”¥ ARCHIVE LOGIC ðŸ”¥
// =================================================================
// ... (loadArchive - unchanged) ...
function loadArchive(){if(!archiveStartDateInput||!archiveEndDateInput||!archiveListEl||!archiveEmptyMsg)return;const s=archiveStartDateInput.value;const e=archiveEndDateInput.value;if(!s||!e){clippySpeak("Select dates.");return;} if(s>e){clippySpeak("Start date after end?");return;} const aT=tasks.filter(t=>t.done&&t.createdDate>=s&&t.createdDate<=e).sort((a,b)=>(b.createdDate||"").localeCompare(a.createdDate||""));archiveListEl.innerHTML='';if(aT.length===0){archiveEmptyMsg.style.display='block';}else{archiveEmptyMsg.style.display='none';aT.forEach(t=>{const li=document.createElement('li');const span=document.createElement('span');span.className='txt';span.textContent=t.text;const dS=document.createElement('span');dS.className='date-stamp';dS.textContent=t.createdDate;li.appendChild(span);li.appendChild(dS);archiveListEl.appendChild(li);});} clippySpeak(`Found ${aT.length} tasks.`);}

// =================================================================
// ðŸ”¥ Report Generation Logic ðŸ”¥
// =================================================================
// ... (analyzeDay, generateDailyReport - unchanged from previous, relies on checkPdfLibraries) ...
function analyzeDay(){const c=currentCounters;const aT=tasks;const ach=c.achievements||0;const emg=c.emergency||0;const log=c.emergencyLog||[];let tA="";let lvl="";let adv="";const{total,done,pct}=getProgress();if(!isViewingHistory){tA=` ${done}/${total} tasks done (${pct}%).`;} if(ach>=currentSettings.dailyGoal&&emg<3){lvl="Excellent";adv=`Incredible! ${tA} Keep momentum!`;}else if(ach>=Math.ceil(currentSettings.dailyGoal/2)&&emg<ach){lvl="Productive";adv=`Solid work. ${tA} Great job!`;}else if(ach>0&&emg>=ach){lvl="Distracted";adv=`Distractions led. Review log. ${tA} New start tomorrow.`;}else if(ach===0&&emg>0){lvl="High Evasion";adv=`Tough start. One achievement helps. ${tA}`;}else{lvl="Quiet/Rest";adv=`Quiet day. Planned rest? ${tA}`;} const q=["Get started.","Discipline bridges goals & accomplishment.","Focus on progress."];const quo=q[Math.floor(Math.random()*q.length)];return{level:lvl,advice:adv,quote:quo,ach:ach,emg:emg,totalTasks:total,doneTasks:done,pctTasks:pct,log:log,allTasks:aT};}
function generateDailyReport(){updateStatus("Generating PDF...");setTimeout(()=>{if(!checkPdfLibraries()){updateStatus("PDF Lib Error",true);return;} try{const{jsPDF}=window.jspdf;const doc=new jsPDF();const dS=getTodayDateString(); const an=analyzeDay();doc.setFont('Helvetica','normal');doc.setFont('Helvetica','bold');doc.setFontSize(18);doc.text("Mohammed's Daily Report",14,22);doc.setFontSize(12);doc.setFont('Helvetica','normal');doc.text(`Date: ${dS}`,14,30);doc.line(14,35,196,35);doc.setFont('Helvetica','bold');doc.setFontSize(14);doc.text("Analysis:",14,45);doc.setFont('Helvetica','normal');doc.setFontSize(12);doc.text(`Level: ${an.level}`,14,53);doc.setFont('Helvetica','italic');const aL=doc.splitTextToSize(an.advice,182);doc.text(aL,14,61);let y=61+(aL.length*7)+5;if(y>270){doc.addPage();y=20;} doc.setFont('Helvetica','bold');doc.setFontSize(14);doc.text("Summary:",14,y);y+=8;doc.setFont('Helvetica','normal');doc.setFontSize(12);doc.text(`- ${currentSettings.labels.achievements}: ${an.ach}`,20,y);doc.text(`- ${currentSettings.labels.emergency}: ${an.emg}`,100,y);y+=8;doc.text(`- Tasks Completed: ${an.doneTasks}/${an.totalTasks} (${an.pctTasks}%)`,20,y);y+=10;if(y>270){doc.addPage();y=20;} doc.setFont('Helvetica','bold');doc.setFontSize(14);doc.text("Emergency Log:",14,y);y+=8;doc.setFont('Helvetica','normal');doc.setFontSize(10);if(an.log&&an.log.length>0){const lL=an.log.map((e,i)=>`${i+1}. ${e}`);const sL=doc.splitTextToSize(lL.join('\n'),182);if(y+(sL.length*5)>280){doc.addPage();y=20;} doc.text(sL,14,y,{lang:'ar'});y+=(sL.length*5)+5;}else{if(y>270){doc.addPage();y=20;} doc.text("(No logs)",14,y);y+=10;} if(an.allTasks.length>0){const comp=an.allTasks.filter(t=>t.done).map(t=>[t.text]);const pend=an.allTasks.filter(t=>!t.done).map(t=>[t.text]);const tblOpt={startY:y,theme:'grid',headStyles:{font:'Helvetica',fontStyle:'bold',fillColor:[220,220,220],textColor:[0,0,0],fontSize:10},bodyStyles:{font:'Helvetica',fontSize:9,cellPadding:2},columnStyles:{0:{cellWidth:'auto'}},margin:{left:14,right:14},didDrawPage:(d)=>{y=d.cursor.y+10;}};const drawTbl=(h,b)=>{const estH=(b.length+1)*7+10;if(y+estH>280){doc.addPage();y=20;} tblOpt.startY=y;doc.autoTable({...tblOpt,head:[[h]],body:b});y=doc.autoTable.previous.finalY+10;};if(comp.length>0){drawTbl('Completed Tasks',comp);} if(pend.length>0){drawTbl('Pending Tasks',pend);}} if(y>270){doc.addPage();y=20;} doc.setFont('Helvetica','italic');doc.setFontSize(12);const qL=doc.splitTextToSize(`"${an.quote}"`,182);doc.text(qL,14,y);doc.save(`Report-${dS}.pdf`);clippySpeak("PDF report generated!");updateStatus("Report Saved");}catch(e){console.error("PDF Fail:",e);clippySpeak("PDF generation error.");updateStatus("PDF Error",true);alert("PDF Fail. See console.");}}, 500); } // 500ms delay


// =================================================================
// ðŸ”¥ INIT (Assign Elements & Attach Listeners) ðŸ”¥
// =================================================================
document.addEventListener('DOMContentLoaded', () => {

    // Assign DOM Elements Safely
    listEl=document.getElementById('list');newTaskEl=document.getElementById('newTask');addBtn=document.getElementById('addBtn');resetAllBtn=document.getElementById('resetAllBtn');emptyMessageEl=document.getElementById('emptyMessage');statusTotalEl=document.getElementById('status-total');statusSaveEl=document.getElementById('status-save');dreadTaskNameEl=document.getElementById('dread-task-name');allCounterButtons=document.querySelectorAll('.counter-fieldset button');logTextareaEl=document.getElementById('emergency-log');emergencyLogLegendEl=document.getElementById('emergency-log-legend');soundTada=document.getElementById('sound-tada');soundError=document.getElementById('sound-error');addTaskFieldset=document.getElementById('add-task-fieldset');progressBarContainer=document.getElementById('progress-bar-container');dreadAnalysisFieldset=document.getElementById('dread-analysis-fieldset');taskListLegendEl=document.getElementById('task-list-legend');logonScreenEl=document.getElementById('logon-screen');logonBtnEl=document.getElementById('logon-ok');reportBtnEl=document.getElementById('report-panel-btn');clippyBtnEl=document.getElementById('clippy-panel-btn');resetTodayBtnEl=document.getElementById('reset-today-panel-btn');tabs=document.querySelectorAll('.tab');tabContents=document.querySelectorAll('.tab-content');settingGoalInput=document.getElementById('setting-goal');settingSoundsCheckbox=document.getElementById('setting-sounds');settingThemeSelect=document.getElementById('setting-theme');settingLabelAchInput=document.getElementById('setting-label-ach');settingLabelNeuInput=document.getElementById('setting-label-neu');settingLabelEmgInput=document.getElementById('setting-label-emg');saveSettingsBtn=document.getElementById('save-settings-btn');notesTextarea=document.getElementById('notes-textarea');notesDateSpan=document.getElementById('notes-date');newQuoteInput=document.getElementById('new-quote-input');addQuoteBtn=document.getElementById('add-quote-btn');quotesListEl=document.getElementById('quotes-list');randomQuoteDisplayEl=document.getElementById('random-quote-display');archiveStartDateInput=document.getElementById('archive-start-date');archiveEndDateInput=document.getElementById('archive-end-date');loadArchiveBtn=document.getElementById('load-archive-btn');archiveListEl=document.getElementById('archive-list');archiveEmptyMsg=document.getElementById('archive-empty');

    // Add IDs if missing
    const pbDiv = document.getElementById('v-linear'); if (pbDiv && !pbDiv.id) pbDiv.id='progress-bar-container'; progressBarContainer = document.getElementById('progress-bar-container');
    const tlFieldset = document.getElementById('task-list-fieldset'); const tlLegend = tlFieldset ? tlFieldset.querySelector('legend') : null; if(tlLegend && !tlLegend.id) tlLegend.id='task-list-legend'; taskListLegendEl = document.getElementById('task-list-legend');

    // Load Clippy Agent
    if (typeof clippy !== 'undefined') {
        clippy.load('Clippy', (agent) => { clippyAgent = agent; console.log("Clippy loaded."); if (clippyBtnEl) clippyBtnEl.disabled = false; }, (error) => { console.error("Clippy load fail:", error); if (clippyBtnEl) clippyBtnEl.disabled = true; });
    } else { console.error("Clippy library missing!"); if (clippyBtnEl) clippyBtnEl.disabled = true; }

    // --- Attach Event Listeners Safely ---
    if (logonBtnEl) { logonBtnEl.addEventListener('click', () => { if (logonScreenEl) logonScreenEl.style.display = 'none'; }); } else { console.warn("Logon button missing."); }
    if (reportBtnEl) { reportBtnEl.addEventListener('click', generateDailyReport); } else { console.warn("Report button missing."); }
    if (clippyBtnEl) { /* Listener added AFTER clippy loads */ } else { console.warn("Clippy button missing."); }
    if (resetTodayBtnEl) { resetTodayBtnEl.addEventListener('click', handleResetTodayCounters); } else { console.warn("Reset Today button missing."); }
    if (addBtn) { addBtn.addEventListener('click', handleAddTask); } else { console.warn("Add Task button missing."); }
    if (newTaskEl) { newTaskEl.addEventListener('keydown', e => { if(e.key==='Enter') handleAddTask(); }); } else { console.warn("New task input missing."); }
    if (resetAllBtn) { resetAllBtn.addEventListener('click', handleResetAll); } else { console.warn("Reset All button missing."); }
    if (saveSettingsBtn) { saveSettingsBtn.addEventListener('click', saveSettings); } else { console.warn("Save Settings button missing."); }
    if (notesTextarea) { notesTextarea.addEventListener('input', debounceSaveNote); } else { console.warn("Notes textarea missing."); }
    if (addQuoteBtn) { addQuoteBtn.addEventListener('click', addQuote); } else { console.warn("Add Quote button missing."); }
    if (newQuoteInput) { newQuoteInput.addEventListener('keydown', e => { if(e.key==='Enter') addQuote(); }); } else { console.warn("New quote input missing."); }
    if (loadArchiveBtn) { loadArchiveBtn.addEventListener('click', loadArchive); } else { console.warn("Load Archive button missing."); }
    if (tabs && tabs.length > 0) { tabs.forEach(tab => { tab.addEventListener('click', () => activateTab(tab.dataset.tab)); }); } else { console.warn("Tab elements missing."); }
    /* REMOVED History View Listeners */

    // --- Start Firebase Listeners (only if initialized successfully) ---
    if (firebaseInitialized && db) {
        updateStatus("Connecting...");
        listenForSettings(); // Load settings first
        listenForTasks();    // Then tasks
        listenForQuotes();   // Then quotes
        counter_listenForChanges(); // Load today's counters (will trigger Ready status)
    } else {
        updateStatus('DB Connection Error!', true); console.error("DB not initialized. App limited.");
         const elementsToDisable = [addBtn, resetAllBtn, reportBtnEl, clippyBtnEl, resetTodayBtnEl, /* historyLoadBtn, */ newTaskEl, saveSettingsBtn, notesTextarea, addQuoteBtn, loadArchiveBtn];
         elementsToDisable.forEach(el => { if (el) el.disabled = true; });
         if (allCounterButtons) allCounterButtons.forEach(btn => btn.disabled = true);
         if (listEl) listEl.innerHTML = '<li><span class="txt" style="color: red; font-weight: bold;">DB Connection Failed. Refresh.</span></li>';
        applySettings(); // Apply default UI
    }
});
</script>
</body>
</html>
