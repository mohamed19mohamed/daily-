<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>mohammed tasks</title>
<meta name="theme-color" content="#c0c0c0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  /* ====== Windows 95 Theme Variables (W95 Plus) ====== */
  :root{
    --bg:#c0c0c0;
    --fg:#000000;
    --accent:#000080;
    --accent-fg:#ffffff;
    --line-dark:#808080;
    --line-medium:#a0a0a0;
    --line-light:#ffffff;
    --input-fill:#ffffff;
    --font:'Tahoma', 'Arial', sans-serif;
    --progress-color:#008040;
    --subtle: #d0d0d0;
    --taskbar-green: #008080;
  }
  /* ====== Base W95 Styling ====== */
  *{
    box-sizing:border-box;
    font-family: var(--font);
    font-size: 10pt;
    transition: none !important;
  }
  html,body{
    margin:0; background:var(--taskbar-green);
  }
  .wrap{
    max-width:400px;
    margin: 40px auto;
    padding:0;
    background: var(--bg);
    box-shadow: 6px 6px 0 var(--line-dark);
    position: relative;
  }
  .window {
      border-style: solid;
      border-width: 1px;
      border-color: var(--fg) var(--line-light) var(--line-light) var(--fg);
      padding: 2px;
      background: var(--bg);
  }
  .window-inner {
      border-style: solid;
      border-width: 1px;
      border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark);
      padding: 1px;
      background: var(--bg);
  }
  .title-bar {
    background: var(--accent);
    color: var(--accent-fg);
    padding: 3px 6px;
    font-size: 11pt;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--fg);
    background: linear-gradient(90deg, var(--accent) 0%, #1084d8 100%);
  }
  .title-bar-text { flex: 1; padding-left: 8px; display: flex; align-items: center; gap: 6px; }
  .title-bar-controls button {
      background: var(--bg);
      border: 1px solid var(--fg);
      border-right-color: var(--line-dark);
      border-bottom-color: var(--line-dark);
      border-top-color: var(--line-light);
      border-left-color: var(--line-light);
      width: 18px; height: 18px; font-size: 10pt; padding: 0; line-height: 1;
      cursor: default; font-weight: bold;
  }
  .title-bar-controls button:active {
      border-left-color: var(--line-dark);
      border-top-color: var(--line-dark);
      border-right-color: var(--line-light);
      border-bottom-color: var(--line-light);
      padding: 1px 0 0 1px;
  }
  .main-content { padding: 8px; }
  fieldset {
      border-style: solid; border-width: 1px;
      border-color: var(--line-dark) var(--line-light) var(--line-light) var(--line-dark);
      padding: 10px; margin: 8px 0; background: var(--bg);
      box-shadow: 1px 1px 0 var(--line-light) inset, -1px -1px 0 var(--line-dark) inset; 
  }
  legend {
      background: var(--bg); padding: 0 6px; font-weight: bold; color: var(--accent); margin-left: 5px;
  }
  .controls{
    display:flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 8px;
  }
  input[type="text"] {
    border: 1px solid var(--fg); border-left-color: var(--line-dark); border-top-color: var(--line-dark);
    border-right-color: var(--line-light); border-bottom-color: var(--line-light);
    background: var(--input-fill); color: var(--fg); padding: 4px 6px; font-size: 10pt;
    outline: none; box-shadow: none; flex: 1; min-width: 120px;
  }
  input:focus, .btn:focus, .del:focus, input[type="checkbox"]:focus, textarea:focus {
      outline: 1px dashed var(--fg);
      outline-offset: -2px;
  }
  .btn {
    border: 1px solid var(--fg); border-right-color: var(--line-dark); border-bottom-color: var(--line-dark);
    border-top-color: var(--line-light); border-left-color: var(--line-light);
    background: var(--bg); color: var(--fg); padding: 5px 12px; font-weight: normal; 
    cursor: pointer; box-shadow: none; line-height: 1; font-size: 10pt; flex-shrink: 0;
  }
  .btn:active {
    border: 1px solid var(--fg); border-left-color: var(--line-dark); border-top-color: var(--line-dark);
    border-right-color: var(--line-light); border-bottom-color: var(--line-light);
    padding: 6px 12px 4px 12px;
  }
  .btn.ghost { background: var(--bg); box-shadow: none; }
  .btn:hover { background: var(--subtle); }
  .muted{color:var(--fg);font-size:9pt; padding: 0 4px;}
  .toolbar {
      display: flex; gap: 4px; 
      padding: 0;
      margin-top: 8px;
  }
  .toolbar button {
      border: 1px solid var(--fg); border-right-color: var(--line-dark); border-bottom-color: var(--line-dark);
      border-top-color: var(--line-light); border-left-color: var(--line-light);
      padding: 4px 8px;
      flex: 1;
  }
  .toolbar button:active { padding: 5px 8px 3px 8px; }
  .task-list-box {
      border: 1px solid var(--fg); border-left-color: var(--line-dark); border-top-color: var(--line-dark);
      border-right-color: var(--line-light); border-bottom-color: var(--line-light);
      background: var(--input-fill); padding: 0; min-height: 100px; margin-top: 8px;
      box-shadow: 1px 1px 0 var(--line-dark) inset, -1px -1px 0 var(--line-light) inset;
  }
  ul{list-style:none;padding:0;margin:0}
  li{
    display:flex; align-items:center; gap:8px; padding: 4px 8px;
    background: var(--input-fill); color: var(--fg); margin: 0;
    border-bottom: 1px solid var(--line-medium);
    cursor: default; 
  }
  li:hover { background: var(--subtle); }
  li.done { color: var(--line-dark); opacity: 0.9; }
  li.done .txt { text-decoration: line-through; }
  .txt{flex:1; line-height:1.4; font-size: 10pt; min-width: 0;}
  input[type="checkbox"]{
    appearance: none; width: 13px; height: 13px;
    border: 1px solid var(--fg); background: var(--input-fill);
    box-shadow: 1px 1px 0 var(--line-dark) inset, -1px -1px 0 var(--line-light) inset;
    margin: 0; padding: 0; display: grid; place-items: center; flex-shrink: 0;
    cursor: pointer;
  }
  input[type="checkbox"]:checked::after { content: 'âœ“'; color: var(--fg); font-size: 10pt; line-height: 0.8; }
  input[type="checkbox"]:active { box-shadow: 1px 1px 0 var(--line-light) inset, -1px -1px 0 var(--line-dark) inset; }
  .del{ 
      appearance:none; border:0; background:transparent; color:var(--line-dark); font-size:10pt; 
      cursor: pointer; padding: 0 4px; line-height:1; flex-shrink: 0; 
  }
  .del:hover{color:red;}
  .linear-progress-box { margin-top: 8px; }
  .head{display:flex;justify-content:space-between;align-items:center;margin:0 0 4px 0}
  .big{font-weight:bold; font-size: 11pt;}
  .progress{
    height:14px; background: var(--line-dark);
    border: 1px solid var(--fg); border-left-color: var(--line-dark); border-top-color: var(--line-dark);
    border-right-color: var(--line-light); border-bottom-color: var(--line-light);
    overflow:hidden; padding: 2px;
  }
  .bar{ height:100%; width:0; background: var(--progress-color); }
  .status-bar {
      border-top: 1px solid var(--line-light); 
      display: flex; align-items: center;
      padding: 0 0; 
      background: var(--bg);
      height: 24px;
      position: absolute;
      bottom: -2px;
      left: 2px;
      right: 2px;
      width: calc(100% - 4px);
  }
  .start-btn {
      background: var(--bg);
      border: 1px solid var(--fg); border-right-color: var(--line-dark); border-bottom-color: var(--line-dark);
      border-top-color: var(--line-light); border-left-color: var(--line-light);
      font-weight: bold;
      padding: 1px 6px 0 6px;
      margin-right: 2px;
      height: 100%;
      line-height: 1.8;
      font-size: 11pt;
      color: var(--fg);
      cursor: pointer;
      box-shadow: none;
      flex-shrink: 0;
  }
  .start-btn:active {
      border: 1px solid var(--fg); border-left-color: var(--line-dark); border-top-color: var(--line-dark);
      border-right-color: var(--line-light); border-bottom-color: var(--line-light);
      padding: 2px 6px 0 7px;
  }
  .separator {
      height: 100%;
      width: 2px;
      background: var(--bg);
      border-left: 1px solid var(--line-light);
      border-right: 1px solid var(--line-dark);
      margin: 0 2px;
  }
  .status-panel-group {
      display: flex;
      margin-left: auto;
      align-items: center;
      height: 100%;
  }
  .status-panel {
      border: 1px solid var(--line-dark); border-left-color: var(--line-light); border-top-color: var(--line-light);
      padding: 0 8px; line-height: 2.1; font-size: 9pt; flex-shrink: 0; min-width: 60px;
      height: calc(100% - 4px);
      margin: 2px 0 2px 2px;
  }
  .main-content { padding: 8px 8px 30px 8px; }
  
  /* ====== Counter Styles (ADJUSTED FOR SMALLER SIZE) ====== */
  .counters-container {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px; /* Reduced gap */
      padding: 0 0 8px 0; 
  }
  .counter-fieldset {
      text-align: center;
      padding: 8px 5px 5px 5px; /* Reduced padding */
  }
  .counter-fieldset legend {
      font-weight: bold;
      padding: 0 4px; /* Reduced legend padding */
      font-size: 9pt; /* Smaller legend font */
  }
  .counter-fieldset h1 {
      font-size: 2.2rem; /* Significantly smaller font for numbers */
      margin: 0 0 5px 0; /* Reduced margin */
      font-weight: bold;
      color: #000;
      line-height: 1; /* Adjust line height for smaller numbers */
  }
  .counter-fieldset button {
      font-size: 1.1rem; /* Smaller button font */
      font-weight: bold;
      width: 100%;
      height: 28px; /* Smaller button height */
      padding: 0; /* Remove default button padding to fit text */
  }
  .emergency-fieldset {
      background-color: #CC4444; 
      color: #FFFFFF;
  }
  .emergency-fieldset h1 {
      color: #FFFFFF;
  }
  .emergency-fieldset legend {
      color: #FFFFFF;
      background: #CC4444; 
  }
  /* ====== END: Counter Styles ====== */

  /* NEW: HR Separator Style */
  hr {
    border: 0;
    border-top: 1px solid var(--line-dark);
    border-bottom: 1px solid var(--line-light);
    margin: 15px 0;
  }

  /* Adjustments for Emergency Analysis fieldset */
  .info-box fieldset {
      margin-top: 0; /* Remove top margin to pull it closer */
      padding: 8px; /* Reduced padding */
  }
  .info-box legend {
      font-size: 9pt; /* Smaller legend font */
      margin-left: 2px;
  }
  
  /* UPDATED: Style for the new emergency log textarea */
  #emergency-log {
      width: 100%;
      box-sizing: border-box;
      font-family: var(--font);
      font-size: 9pt;
      background: var(--input-fill);
      color: var(--fg);
      border: 1px solid var(--fg); 
      border-left-color: var(--line-dark); 
      border-top-color: var(--line-dark);
      border-right-color: var(--line-light); 
      border-bottom-color: var(--line-light);
      box-shadow: 1px 1px 0 var(--line-dark) inset, -1px -1px 0 var(--line-light) inset;
  }

  /* NEW: Report Button Style */
  #report-panel-btn {
    cursor: pointer;
    border: 1px solid var(--line-light);
    border-right-color: var(--line-dark);
    border-bottom-color: var(--line-dark);
  }
  #report-panel-btn:active {
    border: 1px solid var(--line-dark);
    border-right-color: var(--line-light);
    border-bottom-color: var(--line-light);
  }

  /* NEW: Logon Screen Styles (Idea #2) */
  #logon-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--taskbar-green);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #logon-window {
    width: 350px;
    padding-bottom: 10px;
  }
  #logon-content {
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
  }
  #logon-content i {
    font-size: 48px;
    color: var(--accent);
  }
  #logon-buttons {
    text-align: center;
    padding: 0 20px;
  }
  #logon-ok {
    width: 100px;
  }

  @media (max-width: 768px) {
      .wrap { 
          max-width: 100%; 
          margin: 0; 
          height: 100vh;
          box-shadow: none;
      }
      .main-content { padding: 4px 4px 30px 4px; }
      .controls { flex-direction: column; align-items: stretch; gap: 4px; }
      .controls > * { width: 100%; }
      .controls label { flex: none; width: 100%; padding-bottom: 2px; }
      .toolbar button { flex: 1; }
      .task-list-box { min-height: 200px; }
      li { padding: 6px 8px; }
      .status-bar { width: 100%; left: 0; right: 0; bottom: 0; position: fixed; }
      .status-panel-group { margin-left: auto; }

      .counters-container {
        gap: 4px;
        padding: 4px 0 4px 0;
      }
      .counter-fieldset {
        padding: 6px 4px 4px 4px;
      }
      .counter-fieldset h1 {
        font-size: 1.8rem;
      }
      .counter-fieldset button {
        height: 24px;
        font-size: 1rem;
      }
      .counter-fieldset legend {
          font-size: 8pt;
      }
      .info-box p, .info-box .sunken-panel {
          font-size: 8pt;
      }
  }
</style>
</head>
<body dir="ltr">

  <div id="logon-screen">
    <div class="window" id="logon-window">
        <div class="title-bar">
            <div class="title-bar-text">Logon to Mohammed's System</div>
        </div>
        <div id="logon-content">
            <i class="fas fa-user-circle"></i>
            <div>
                <p style="margin: 0 0 5px 0;">Welcome back, <strong>Mohammed</strong>.</p>
                <p style="margin: 0;">Click OK to load your task environment.</p>
            </div>
        </div>
        <div id="logon-buttons">
            <button class="btn" id="logon-ok">OK</button>
        </div>
    </div>
  </div>

  <main class="wrap window">
    <div class="window-inner">
      <div class="title-bar">
          <div class="title-bar-text">
              <i class="fas fa-user-circle"></i>
              <span>mohammed tasks</span>
          </div>
          <div class="title-bar-controls">
              <button title="Minimize" class="title-btn-min">_</button>
              <button title="Maximize" class="title-btn-max">â–¡</button>
              <button title="Close" class="title-btn-close">X</button>
          </div>
      </div>

      <div class="main-content">
          
        <div class="counters-container">
            <fieldset class="counter-fieldset">
                <legend>Achievements</legend>
                <h1 id="achievements-count">0</h1>
                <button onclick="counter_increment('achievements')" class="btn">+</button>
            </fieldset>

            <fieldset class="counter-fieldset">
                <legend>Neutral</legend>
                <h1 id="neutral-count">0</h1>
                <button onclick="counter_increment('neutral')" class="btn">+</button>
            </fieldset>

            <fieldset class="counter-fieldset emergency-fieldset">
                <legend>Emergency</legend>
                <h1 id="emergency-count">0</h1>
                <button onclick="counter_increment('emergency')" class="btn">+</button>
            </fieldset>
        </div>
        
        <div class="info-box" style="padding: 0; margin: 0;">
            <fieldset>
                <legend>Today's Emergency Log</legend>
                <div style="padding: 5px;">
                    <textarea id="emergency-log" readonly rows="3"></textarea>
                </div>
            </fieldset>
        </div>
        
        <hr>
        <fieldset>
            <legend>Add New Task</legend>
            <div class="controls">
                <label for="newTask" style="flex: 0 0 100px;">Task (Required):</label>
                <input id="newTask" type="text" placeholder="Brief description of the taskâ€¦"/>
            </div>
            
            <div class="toolbar">
                <button class="btn" id="addBtn"><i class="fas fa-plus"></i> Add Task</button>
                <button class="btn ghost" id="resetBtn" title="Delete all tasks"><i class="fas fa-trash-alt"></i> Reset All</button>
            </div>
        </fieldset>
        
        <div id="v-linear" class="linear-progress-box">
          <div class="head">
            <div><span class="big" id="pct1">0%</span> <span class="muted">Overall Progress</span></div>
            <div class="muted"><span id="done1">0</span>/<span id="total1">0</span> Tasks</div>
          </div>
          <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div id="bar1" class="bar"></div>
          </div>
        </div>
        
        <div class="task-list-box">
            <ul id="list"></ul>
        </div>
        
        <div id="emptyMessage" class="muted" style="text-align: center; margin-top: 8px; font-weight: bold; display: none;">
          No tasks currently. Start by adding one!
        </div>
      </div>
      
      <div class="status-bar">
          <button class="start-btn">Start</button>
          <div class="separator"></div>
          <div class="status-panel" style="flex-grow: 1; margin-right: 0; text-align: left; min-width: 0;">
              mohammed tasks
          </div>
          <div class="status-panel-group">
            <div class="status-panel" id="report-panel-btn" role="button" title="Generate Daily Report">
              <i class="fas fa-print"></i> Report
            </div>
            <div class="status-panel" id="status-total">Total: 0</div>
            <div class="status-panel" id="status-save">Ready</div>
          </div>
      </div>
    </div>
  </main>

<script>
// =================================================================
// ðŸ”¥ FIREBASE INITIALIZATION & CONFIG ðŸ”¥
// =================================================================

// The firebase object should be defined now, if internet is on.
const firebaseConfig = {
  // Ù…ÙØ§ØªÙŠØ­Ùƒ Ø§Ù„ØªÙŠ ØªÙ… ØªØ£ÙƒÙŠØ¯Ù‡Ø§
  apiKey: "AIzaSyBvpcUP-DmXH82WHgm4ZLHezeBFaaxMnCE",
  authDomain: "mohammedtasksapp.firebaseapp.com",
  databaseURL: "https://mohammedtasksapp-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mohammedtasksapp",
  storageBucket: "mohammedtasksapp.firebasestorage.app",
  messagingSenderId: "271781862481",
  appId: "1:271781862481:web:dfd63b2c4b4a8d74ad2c70"
};

// Initialize Firebase
try {
    firebase.initializeApp(firebaseConfig);
} catch (e) {
    console.error("Firebase initialization failed:", e);
    alert("CRITICAL ERROR: Firebase libraries did not load. Please check your internet connection and refresh the page.");
}

const db = firebase.database();

// =================================================================
// ðŸ”¥ COUNTER LOGIC (Firebase) ðŸ”¥
// =================================================================

let todayCounterRef = null;
let currentCounters = { achievements: 0, neutral: 0, emergency: 0, emergencyLog: [] }; 

function counter_getTodayDateString() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function counter_listenForChanges() {
    const today = counter_getTodayDateString();
    todayCounterRef = db.ref('dailyCounters/' + today);
    
    todayCounterRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            currentCounters = data;
        } else {
            currentCounters = { achievements: 0, neutral: 0, emergency: 0, emergencyLog: [] }; 
            todayCounterRef.set(currentCounters).catch(e => console.error("Initial counter set failed:", e));
        }
        
        document.getElementById('achievements-count').innerText = currentCounters.achievements || 0;
        document.getElementById('neutral-count').innerText = currentCounters.neutral || 0;
        document.getElementById('emergency-count').innerText = currentCounters.emergency || 0;
        
        const logTextarea = document.getElementById('emergency-log');
        const logData = currentCounters.emergencyLog || [];
        if (logData.length > 0) {
            logTextarea.value = logData.join('\n'); 
        } else {
            logTextarea.value = '(No emergencies logged today)';
        }
        logTextarea.scrollTop = logTextarea.scrollHeight; 
    }, (error) => {
        console.error("Firebase Counter Read Failed. Check your Firebase Rules:", error);
        if(statusSaveEl) updateStatus('Counter Sync Error');
    });
}

function counter_increment(type) {
    let finalReason = ""; 
    let updates = {};

    if (type === 'emergency') {
        let reasonInput = prompt("EMERGENCY: Select category or type your own:\n\n1. Social Media\n2. Phone/Calls\n3. Procrastination\n4. Other (Specify)");
        
        if (reasonInput === "1") finalReason = "Social Media";
        else if (reasonInput === "2") finalReason = "Phone/Calls";
        else if (reasonInput === "3") finalReason = "Procrastination";
        else if (reasonInput === "4") finalReason = prompt("Specify 'Other' reason:") || "Other (Unspecified)";
        else if (reasonInput && reasonInput.trim() !== "") finalReason = reasonInput;
        else return; 
        
        const currentLog = currentCounters.emergencyLog || [];
        currentLog.push(finalReason);
        updates.emergencyLog = currentLog; 
    }

    const newCount = (currentCounters[type] || 0) + 1;
    updates[type] = newCount;
    
    if (todayCounterRef) {
        todayCounterRef.update(updates).catch(e => console.error("Counter update failed:", e));
    }

    if (type === 'achievements' && newCount === 10) {
        alert('Congratulations! You completed 10 achievements! You deserve a prize!');
    }
}

// =================================================================
// ðŸ”¥ TASK APP LOGIC (Firebase) ðŸ”¥
// =================================================================

const tasksRef = db.ref('tasks');
let tasks = []; 
let listEl, newTaskEl, addBtn, resetBtn, emptyMessageEl, statusTotalEl, statusSaveEl;

function todayDate() { return new Date().toISOString().substring(0, 10); }

function updateStatus(message) {
    if (statusSaveEl) {
        statusSaveEl.textContent = message;
        setTimeout(() => { statusSaveEl.textContent = 'Ready'; }, 2000);
    }
}

function listenForTasks() {
    tasksRef.on('value', (snapshot) => {
        const rawData = snapshot.val();
        tasks = [];
        if (rawData) {
            for (let id in rawData) {
                tasks.push({ ...rawData[id], id: id });
            }
        }
        renderList();
        updateLinearView();
        updateStatus('Synced');
    }, (error) => {
        console.error("Firebase Read Failed. Check your Firebase Rules:", error);
        updateStatus('Task Sync Error');
    });
}

function addTaskToDB(text) {
    const newTask = {
        text: text, 
        done: false, 
        createdDate: todayDate() 
    };
    tasksRef.push(newTask).catch((error) => {
        console.error("Firebase Write Failed. Check Rules.", error);
        updateStatus('Write Error');
    });
}

function updateTaskStatus(id, isDone) {
    tasksRef.child(id).update({ done: isDone }).catch((error) => {
        console.error("Firebase Update Failed. Check Rules.", error);
        updateStatus('Update Error');
    });
}

function deleteTask(id) {
    tasksRef.child(id).remove().catch((error) => {
        console.error("Firebase Delete Failed. Check Rules.", error);
        updateStatus('Delete Error');
    });
}

function deleteAllTasks() {
    tasksRef.remove().catch((error) => {
        console.error("Firebase Clear Failed. Check Rules.", error);
        updateStatus('Clear Error');
    });
}

function getSortedTasks() {
    tasks.sort((a, b) => {
        if (a.createdDate < b.createdDate) return 1;
        if (a.createdDate > b.createdDate) return -1;
        return 0;
    });
    return tasks;
}

function renderList(){
    const sortedTasks = getSortedTasks();
    if (!listEl) return; 
    
    listEl.innerHTML = '';
    
    if (sortedTasks.length === 0) {
        if (emptyMessageEl) emptyMessageEl.style.display = 'block';
    } else {
        if (emptyMessageEl) emptyMessageEl.style.display = 'none';
    }

    sortedTasks.forEach(t=>{
      const li = document.createElement('li');
      if (t.done) li.classList.add('done');
      const cb = document.createElement('input');
      cb.type='checkbox'; cb.checked=t.done;
      cb.addEventListener('change',()=>{ updateTaskStatus(t.id, cb.checked); });
      const span = document.createElement('span');
      span.className='txt'; span.textContent=t.text;
      const del = document.createElement('button');
      del.className='del'; del.innerHTML='<i class="fas fa-trash"></i>';
      del.addEventListener('click',()=>{ deleteTask(t.id); });
      li.appendChild(cb); 
      li.appendChild(span); 
      li.appendChild(del);
      listEl.appendChild(li);
    });
    
    if (statusTotalEl) statusTotalEl.textContent = `Total: ${tasks.length}`;
}

function handleAddTask(){
    const text = (newTaskEl.value||'').trim(); 
    if(!text) {
        alert("Task description is required.");
        return;
    }
    addTaskToDB(text); 
    newTaskEl.value=''; 
}

function handleResetAll(){
    if(!confirm('Are you sure you want to delete ALL tasks?\n\nThis will ALSO reset today\'s counters and emergency log.')) return;
    deleteAllTasks(); 
    if (todayCounterRef) {
        todayCounterRef.remove().catch(e => console.error("Counter reset failed:", e));
    }
}

function getProgress(){
    const total = tasks.length;
    const done  = tasks.filter(t=>t.done).length;
    const pct   = total ? Math.round((done/total)*100) : 0;
    return {total, done, pct};
}

function updateLinearView(){
    const {total,done,pct} = getProgress();
    const bar = document.getElementById('bar1');
    const pctEl = document.getElementById('pct1');
    const doneEl= document.getElementById('done1');
    const totalEl= document.getElementById('total1');
    
    if(bar){ bar.style.width = pct + '%'; }
    if(pctEl) pctEl.textContent = pct + '%';
    if(doneEl) doneEl.textContent = done;
    if(totalEl) totalEl.textContent = total;
    
    const pb = document.querySelector('#v-linear .progress[role="progressbar"]');
    if(pb) pb.setAttribute('aria-valuenow', pct);
}

// =================================================================
// ðŸ”¥ NEW: Report Generation Logic ðŸ”¥
// =================================================================

function analyzeDay() {
    const counters = currentCounters;
    const allTasks = tasks; 

    const ach = counters.achievements || 0;
    const emg = counters.emergency || 0;
    const log = counters.emergencyLog || [];
    const totalTasks = allTasks.length;
    const doneTasks = allTasks.filter(t => t.done).length;
    const pctTasks = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;

    let level = "";
    let advice = "";

    if (ach >= 10 && emg < 3) {
        level = "Excellent Focus";
        advice = "Incredible performance! You hit your achievement goal with minimal distractions. This is a model day. Keep this momentum!";
    } else if (ach >= 5 && emg < ach) {
        level = "Productive Day";
        advice = "A solid, productive day. You balanced your work and distractions well, with achievements leading the way. Great job!";
    } else if (ach > 0 && emg >= ach) {
        level = "Distracted Day";
        advice = "You got some work done, but distractions took the lead. Review the 'Emergency Log' to see the pattern. Tomorrow is a new start.";
    } else if (ach === 0 && emg > 0) {
        level = "High Evasion Day";
        advice = "It seems today was a tough day to get started. Remember, even one small 'Achievement' can break the cycle and build momentum.";
    } else if (ach === 0 && emg === 0 && totalTasks > 0 && doneTasks === 0) {
        level = "Task Evasion Day";
        advice = "You've listed your tasks but haven't logged any progress. The first step is the hardest. Let's try to get one 'Achievement' tomorrow.";
    } else {
        level = "Quiet Day / Rest Day";
        advice = "A quiet day. If this was a planned rest day, great! If not, remember to log your progress.";
    }

    const quotes = [
        "The secret of getting ahead is getting started.",
        "Discipline is the bridge between goals and accomplishment.",
        "You don't have to be great to start, but you have to start to be great.",
        "Focus on progress, not perfection."
    ];
    const quote = quotes[Math.floor(Math.random() * quotes.length)];

    return { level, advice, quote, ach, emg, totalTasks, doneTasks, pctTasks, log };
}

function generateDailyReport() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const today = counter_getTodayDateString();
        const analysis = analyzeDay();
        
        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(18);
        doc.text("Mohammed's Daily Report", 14, 22);
        doc.setFontSize(12);
        doc.setFont('Helvetica', 'normal');
        doc.text(`Date: ${today}`, 14, 30);
        doc.line(14, 35, 196, 35); 
        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(14);
        doc.text("Today's Analysis:", 14, 45);
        doc.setFont('Helvetica', 'normal');
        doc.setFontSize(12);
        doc.text(`Your Level: ${analysis.level}`, 14, 53);
        doc.setFont('Helvetica', 'italic');
        const adviceLines = doc.splitTextToSize(analysis.advice, 182);
        doc.text(adviceLines, 14, 61);
        let y = 61 + (adviceLines.length * 7) + 5; 
        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(14);
        doc.text("Summary:", 14, y);
        y += 8;
        doc.setFont('Helvetica', 'normal');
        doc.setFontSize(12);
        doc.text(`- Achievements Logged: ${analysis.ach}`, 20, y);
        doc.text(`- Emergencies Logged: ${analysis.emg}`, 100, y);
        y += 8;
        doc.text(`- Tasks Completed: ${analysis.doneTasks} / ${analysis.totalTasks} (${analysis.pctTasks}%)`, 20, y);
        y += 10;
        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(14);
        doc.text("Emergency Log Review:", 14, y);
        y += 8;
        doc.setFont('Helvetica', 'normal');
        doc.setFontSize(10);
        if (analysis.log.length > 0) {
            const logLines = analysis.log.map((entry, index) => `${index + 1}. ${entry}`);
            const splitLog = doc.splitTextToSize(logLines.join('\n'), 182);
            doc.text(splitLog, 14, y);
            y += (splitLog.length * 5) + 5;
        } else {
            doc.text("(No emergencies logged today. Excellent!)", 14, y);
            y += 10;
        }
        doc.line(14, y, 196, y); 
        y += 8;
        doc.setFont('Helvetica', 'italic');
        doc.setFontSize(12);
        const quoteLines = doc.splitTextToSize(`"${analysis.quote}"`, 182);
        doc.text(quoteLines, 14, y);

        doc.save(`Daily-Report-Mohammed-${today}.pdf`);

    } catch (e) {
        console.error("PDF Generation Failed:", e);
        // Check if jsPDF loaded
        if (typeof jsPDF === 'undefined') {
            alert("Error: PDF library (jsPDF) failed to load. Please check your internet connection and refresh.");
        } else {
            alert("An unknown error occurred during PDF generation.");
        }
    }
}


// =================================================================
// ðŸ”¥ INIT (Start all listeners) ðŸ”¥
// =================================================================
document.addEventListener('DOMContentLoaded', () => {
    
    // Assign all element variables INSIDE this listener
    listEl = document.getElementById('list');
    newTaskEl = document.getElementById('newTask');
    addBtn = document.getElementById('addBtn');
    resetBtn = document.getElementById('resetBtn');
    emptyMessageEl = document.getElementById('emptyMessage');
    statusTotalEl = document.getElementById('status-total');
    statusSaveEl = document.getElementById('status-save');
    
    const logonScreenEl = document.getElementById('logon-screen');
    const logonBtnEl = document.getElementById('logon-ok');
    const reportBtnEl = document.getElementById('report-panel-btn');

    // Logon Screen Logic
    if (logonBtnEl) {
        logonBtnEl.addEventListener('click', () => {
            if (logonScreenEl) logonScreenEl.style.display = 'none';
        });
    }

    // Report Button Logic
    if (reportBtnEl) {
        reportBtnEl.addEventListener('click', generateDailyReport);
    }

    // Task App Listeners
    if (addBtn) {
        addBtn.addEventListener('click', handleAddTask);
    }
    if (newTaskEl) {
        newTaskEl.addEventListener('keydown', e => { if(e.key==='Enter') handleAddTask(); });
    }
    if (resetBtn) {
        resetBtn.addEventListener('click', handleResetAll);
    }

    // Start Firebase Listeners
    // Check if firebase is defined before starting
    if (typeof firebase !== 'undefined') {
        listenForTasks();           // Start listening for FIREBASE task changes
        counter_listenForChanges(); // Start listening for FIREBASE counter changes
    } else {
        // This will show if the libraries failed to load but the script still ran
        alert("Error: Firebase is not loaded. Please check your internet connection and refresh the page.");
    }
});
</script>
</body>
</html>
