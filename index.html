// =================================================================
// ðŸ”¥ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø±Ø¨Ø· Firebase Ø¨Ø§Ù„ØªØ²Ø§Ù…Ù† ðŸ”¥
// =================================================================

// 1. Firebase Libraries (The links are already in the HTML file body)
// <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
// <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

// 2. PASTE YOUR FIREBASE CONFIGURATION HERE (ØªÙ… Ø§Ù„Ù„ØµÙ‚ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„):
// ØªÙ… Ø£Ø®Ø° Ù…ÙØ§ØªÙŠØ­Ùƒ Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§ØŒ Ù„ÙƒÙ† ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø²Ø§Ø¦Ø¯Ø© Ø§Ù„ØªÙŠ Ù„Ø§ Ù†Ø­ØªØ§Ø¬Ù‡Ø§ (Ù…Ø«Ù„ measurementId)
const firebaseConfig = {
  apiKey: "AIzaSyBvpcUP-DmXH82WHgm4ZLHezeBFaaxMnCE",
  authDomain: "mohammedtasksapp.firebaseapp.com",
  databaseURL: "https://mohammedtasksapp-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mohammedtasksapp",
  storageBucket: "mohammedtasksapp.firebasestorage.app",
  messagingSenderId: "271781862481",
  appId: "1:271781862481:web:dfd63b2c4b4a8d74ad2c70"
};

// Initialize Firebase (ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙÙŠ Ø§Ù„Ù…Ù„Ù)
firebase.initializeApp(firebaseConfig);

// Reference to the database location where tasks will be stored
const db = firebase.database();
const tasksRef = db.ref('tasks');

// ---- State ----
let tasks = []; 

// ---- DOM ----
const listEl    = document.getElementById('list');
const newTaskEl = document.getElementById('newTask');
const addBtn    = document.getElementById('addBtn');
const resetBtn  = document.getElementById('resetBtn');
const emptyMessageEl = document.getElementById('emptyMessage');
const statusTotalEl = document.getElementById('status-total');
const statusSaveEl = document.getElementById('status-save');

// ---- UID & Date ----
function todayDate() { return new Date().toISOString().substring(0, 10); }

// ---- Status Bar ----
function updateStatus(message) {
    statusSaveEl.textContent = message;
    setTimeout(() => { statusSaveEl.textContent = 'Ready'; }, 2000);
}

// ---- Firebase Functions (REPLACING Local Storage) ----

// 1. Listen for real-time changes
function listenForTasks() {
    tasksRef.on('value', (snapshot) => {
        const rawData = snapshot.val();
        tasks = [];
        if (rawData) {
            for (let id in rawData) {
                tasks.push({ ...rawData[id], id: id });
            }
        }
        
        renderList();
        updateLinearView();
        updateStatus('Synced');
    }, (error) => {
        console.error("Firebase Read Failed:", error);
        updateStatus('Sync Error');
    });
}

// 2. Add a new task to the database
function addTaskToDB(text) {
    const newTask = {
        text: text, 
        done: false, 
        createdDate: todayDate() 
    };
    tasksRef.push(newTask)
        .then(() => {
            updateStatus('Task Added');
        })
        .catch((error) => {
            console.error("Firebase Write Failed:", error);
            updateStatus('Error Adding');
        });
}

// 3. Update task status (done/undone)
function updateTaskStatus(id, isDone) {
    tasksRef.child(id).update({ done: isDone })
        .then(() => {
            updateStatus('Task Updated');
        })
        .catch((error) => {
            console.error("Firebase Update Failed:", error);
            updateStatus('Error Updating');
        });
}

// 4. Delete a task
function deleteTask(id) {
    tasksRef.child(id).remove()
        .then(() => {
            updateStatus('Task Deleted');
        })
        .catch((error) => {
            console.error("Firebase Delete Failed:", error);
            updateStatus('Error Deleting');
        });
}

// 5. Delete ALL tasks
function deleteAllTasks() {
    tasksRef.remove()
        .then(() => {
            updateStatus('All Tasks Cleared');
        })
        .catch((error) => {
            console.error("Firebase Clear Failed:", error);
            updateStatus('Error Clearing');
        });
}

// ---- Sorting Logic (Newest first) ----
function getSortedTasks() {
    tasks.sort((a, b) => {
        if (a.createdDate < b.createdDate) return 1;
        if (a.createdDate > b.createdDate) return -1;
        return 0;
    });
    return tasks;
}

// ---- Render list ----
function renderList(){
    const sortedTasks = getSortedTasks();
    listEl.innerHTML = '';
    
    if (sortedTasks.length === 0) {
        emptyMessageEl.style.display = 'block';
    } else {
        emptyMessageEl.style.display = 'none';
    }

    sortedTasks.forEach(t=>{
      const li = document.createElement('li');
      if (t.done) li.classList.add('done');

      const cb = document.createElement('input');
      cb.type='checkbox'; cb.checked=t.done;
      cb.addEventListener('change',()=>{ 
          updateTaskStatus(t.id, cb.checked);
      });

      const span = document.createElement('span');
      span.className='txt'; span.textContent=t.text;
      
      const del = document.createElement('button');
      del.className='del'; del.innerHTML='<i class="fas fa-trash"></i>';
      del.addEventListener('click',()=>{ 
          deleteTask(t.id);
      });

      li.appendChild(cb); 
      li.appendChild(span); 
      li.appendChild(del);
      
      listEl.appendChild(li);
    });
    
    statusTotalEl.textContent = `Total: ${tasks.length}`;
}

// ---- Add / Reset Handlers ----
function handleAddTask(){
    const text = (newTaskEl.value||'').trim(); 
    if(!text) {
        // Ù†Ø³ØªØ®Ø¯Ù… Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ø£Ù†Ù‡Ø§ ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯ Ù‡Ù†Ø§
        alert("Task description is required.");
        return;
    }
    
    addTaskToDB(text); 
    newTaskEl.value=''; 
}

function handleResetAll(){
    if(!confirm('Are you sure you want to reset (delete all tasks)?')) return;
    deleteAllTasks(); 
}

// ---- Progress calc & Update Linear View ----
function getProgress(){
    const total = tasks.length;
    const done  = tasks.filter(t=>t.done).length;
    const pct   = total ? Math.round((done/total)*100) : 0;
    return {total, done, pct};
}

function updateLinearView(){
    const {total,done,pct} = getProgress();
    const bar = document.getElementById('bar1');
    const pctEl = document.getElementById('pct1');
    const doneEl= document.getElementById('done1');
    const totalEl= document.getElementById('total1');
    
    if(bar){ bar.style.width = pct + '%'; }
    if(pctEl) pctEl.textContent = pct + '%';
    if(doneEl) doneEl.textContent = done;
    if(totalEl) totalEl.textContent = total;
    
    const pb = document.querySelector('#v-linear .progress[role="progressbar"]');
    if(pb) pb.setAttribute('aria-valuenow', pct);
}

// ---- Events ----
addBtn.addEventListener('click', handleAddTask);
newTaskEl.addEventListener('keydown', e=>{ if(e.key==='Enter') handleAddTask(); });
resetBtn.addEventListener('click', handleResetAll);

// ---- Init ----
listenForTasks();
